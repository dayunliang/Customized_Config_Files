# ┌────────────────────────────────────────────────────────────────────────────┐
# │                        MosDNS v4 配置：config_custom.yaml                   │
# │ 适用于 MosDNS 5.3.3 及以下版本（v4 DSL），不要使用 v5 的顶级字段                   │
# └────────────────────────────────────────────────────────────────────────────┘

# 日志配置：控制台 & 文件双输出，帮助排查启动和运行时问题
log:
  level: debug            # 日志级别：trace/debug/info/warn/error，debug 输出最详尽调试信息
  file: "/var/log/mosdns.log"  # 日志文件路径，请确保容器内此路径存在且可写

# 管理 API：通过 HTTP 端口可远程查询当前状态或动态修改配置
api:
  http: "0.0.0.0:8338"     # 0.0.0.0 绑定所有网卡，8338 为监听端口

# ┌─────────────────────────── 引入外部配置 ────────────────────────────┐
# │ 加载 dat_exec.yaml（定义数据源、ECS、TTL 调整插件）                    │
# │ 加载 dns.yaml（定义上游 forward 插件：ADH_CN/ADH_GFW）                │
# └───────────────────────────────────────────────────────────────────┘
include:
  - "/etc/mosdns/dat_exec.yaml"
  - "/etc/mosdns/dns.yaml"

# ┌─────────────────────────── 插件定义 ─────────────────────────────┐
# │ 在此块中定义所有插件：包括自定义逻辑、分流主流程及服务入口               │
# └─────────────────────────────────────────────────────────────────┘
plugins:

  # ┌────────────────────────────────────────────────────────────────────────┐
  # │ reject_ads：广告域名拒绝插件                                              │
  # │   type: sequence    由多个 exec 组成，实现复杂动作                         │
  # │   作用：对 qname 匹配广告列表时，使用 reject 3 返回 NXDOMAIN                │
  # └────────────────────────────────────────────────────────────────────────┘
  - tag: reject_ads
    type: sequence
    args:
      - exec: "reject 3"  # 内置指令：reject 3 表示 NXDOMAIN
      - exec: "return"    # 中断插件执行，避免跑入后续逻辑

  # ┌────────────────────────────────────────────────────────────────────────┐
  # │ main_sequence：主分流逻辑                                                │
  # │   type: sequence    多步判断+执行                                        │
  # │   作用：                                                                │
  # │     1) 若域名属于 geosite_cn，则转发到 ADH_CN；                            │
  # │     2) 若域名属于广告列表，则调用 reject_ads；                              │
  # │     3) 其它域名则转发到 ADH_GFW。                                         │
  # └────────────────────────────────────────────────────────────────────────┘
  - tag: main_sequence
    type: sequence
    args:

      # —— 步骤 1：匹配中国大陆域名 —— 
      # matches: qname $geosite_cn 使用 dat_exec.yaml 中 geosite_cn 插件加载的域名列表
      # exec:    $ADH_CN       调用 dns.yaml 中定义的国内转发插件
      - matches: qname $geosite_cn
        exec: $ADH_CN
      - exec: "return"       # 匹配后马上退出，不再执行后续规则

      # —— 步骤 2：匹配广告域名 —— 
      # matches: qname $geosite_category-ads-all 使用广告域名集合
      # exec:    $reject_ads   调用广告拒绝插件返回 NXDOMAIN
      - matches: qname $geosite_category-ads-all
        exec: $reject_ads
      - exec: "return"       # 拒绝后退出，避免落入兜底逻辑

      # —— 步骤 3：兜底——其它域名 —— 
      # 无 matches 意味默认命中；exec: $ADH_GFW 调用国外转发插件
      - exec: $ADH_GFW
      - exec: "return"       # 最后退出 sequence

  # ┌────────────────────────────────────────────────────────────────────────┐
  # │ udp_server：UDP 服务入口                                                │
  # │   type: udp_server   监听 UDP 协议，entry 指向主流程 main_sequence        │
  # │   listen: ":5333"    容器内部监听 5333，外部可映射到 53 端口                │
  # └────────────────────────────────────────────────────────────────────────┘
  - type: udp_server
    args:
      entry: main_sequence
      listen: ":5333"

  # ┌────────────────────────────────────────────────────────────────────────┐
  # │ tcp_server：TCP 服务入口（用于大型响应或 DoT）                              │
  # │   type: tcp_server   监听 TCP 协议，同样使用 main_sequence 作为入口        │
  # │   listen: ":5333"    容器内部监听 5333，外部可映射到 53/TCP 端口            │
  # └────────────────────────────────────────────────────────────────────────┘
  - type: tcp_server
    args:
      entry: main_sequence
      listen: ":5333"
