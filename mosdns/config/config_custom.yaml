# MosDNS v4 配置文件：config_custom.yaml
# =============================================================================
# 设计目标说明：
#
# 1️⃣ 使用 MosDNS 作为“规则判断与调度层”
# 2️⃣ 使用 AdGuardHome（ADH_CN / ADH_GFW）作为“真正的解析执行层”
#
# 域名解析总体策略：
# ---------------------------------------------------------------------------
# • hosts 中定义的域名               → 本地直接返回
# • 命中 GFW 列表的域名              → ADH_GFW（走代理/国外出口）
# • 命中广告列表的域名               → 直接拒绝（NXDOMAIN）
# • 其余所有域名（包括：
#     - 中国大陆域名
#     - 国外普通非 GFW 域名
#     - 未被任何 geosite 分类覆盖的域名）
#   → 统一交由 ADH_CN 解析
#
# ⚠️ 重要说明：
# 本配置【并不追求】“所有国外域名都走国外 DNS / 代理 DNS”，
# 而是采用偏实用主义的策略：
#   - 只有明确需要代理的 GFW 域名才走 ADH_GFW
#   - 其它域名即使是国外站点，也允许使用国内 DNS 解析
#
# =============================================================================

log:
  level: debug                  # 日志级别：debug（详细日志，便于排错与验证规则命中）
  file: "/var/log/mosdns.log"   # MosDNS 运行日志文件路径

api:
  http: "0.0.0.0:8338"          # MosDNS HTTP API 接口，用于状态查看与调试

# =============================================================================
# 引入外部配置文件
# =============================================================================
# dat_exec.yaml : 数据处理相关规则（如 ECS、缓存、IP 处理等）
# dns.yaml      : DNS 上游定义（ADH_CN / ADH_GFW 的具体实现）
include:
  - "/etc/mosdns/dat_exec.yaml"
  - "/etc/mosdns/dns.yaml"

# =============================================================================
# 插件定义区
# =============================================================================
plugins:

  # ---------------------------------------------------------------------------
  # reject_ads
  # ---------------------------------------------------------------------------
  # 功能：
  #   对广告域名直接返回 NXDOMAIN，实现“硬拒绝式”广告屏蔽
  - tag: reject_ads
    type: sequence
    args:
      - exec: "reject 3"         # DNS 响应码 3 = NXDOMAIN

  # ---------------------------------------------------------------------------
  # route_cn
  # ---------------------------------------------------------------------------
  # 功能：
  #   匹配中国大陆域名，并交由 ADH_CN 解析
  #
  # 说明：
  #   本配置中，route_cn 并不是唯一进入 ADH_CN 的入口，
  #   它只是一个“显式的 CN 规则匹配”。
  #
  #   实际上，所有未命中 GFW / Ads 的域名，最终都会 fallback 到 ADH_CN。
  - tag: route_cn
    type: sequence
    args:
      - matches: qname $geosite_cn
        exec: $ADH_CN

  # ---------------------------------------------------------------------------
  # route_gfw
  # ---------------------------------------------------------------------------
  # 功能：
  #   匹配 geosite_gfw 列表中的域名，
  #   这些域名被认为“需要代理或国外出口访问”，
  #   统一交由 ADH_GFW 处理
  - tag: route_gfw
    type: sequence
    args:
      - matches: qname $geosite_gfw
        exec: $ADH_GFW

  # ---------------------------------------------------------------------------
  # route_ads
  # ---------------------------------------------------------------------------
  # 功能：
  #   匹配广告/追踪相关域名并直接拒绝解析
  #
  # 说明：
  #   本规则位于主流程中较靠前位置，
  #   以尽可能减少广告域名进入上游解析流程
  - tag: route_ads
    type: sequence
    args:
      - matches: qname $geosite_category-ads-all
        exec: $reject_ads

  # ---------------------------------------------------------------------------
  # local_hosts
  # ---------------------------------------------------------------------------
  # 功能：
  #   使用本地 hosts 文件进行解析
  #
  # 用途：
  #   - 局域网设备固定域名
  #   - 内网服务快速解析
  #   - 覆盖外部 DNS 结果
  - tag: local_hosts
    type: hosts
    args:
      files:
        - /var/mosdns/hosts.txt

  # =============================================================================
  # 主处理流程：main_sequence
  # =============================================================================
  # 执行顺序与逻辑说明：
  #
  # 1️⃣ local_hosts
  #    - 若命中 hosts，直接返回结果
  #
  # 2️⃣ route_gfw
  #    - 若命中 GFW 域名，交由 ADH_GFW 解析
  #
  # 3️⃣ route_ads
  #    - 若为广告域名，直接返回 NXDOMAIN
  #
  # 4️⃣ has_resp → return
  #    - 若前面任一规则已产生响应，则立即结束处理
  #
  # 5️⃣ fallback：ADH_CN
  #    - 所有未被拦截、未命中 GFW 的域名
  #    - 包括国内域名、国外普通非 GFW 域名
  #    - 统一交由 ADH_CN 解析
  #
  - tag: main_sequence
    type: sequence
    args:
      - exec: $local_hosts
      - exec: $route_gfw
      - exec: $route_ads
      - matches: has_resp
        exec: return
      - exec: $ADH_CN

  # =============================================================================
  # DNS 服务监听
  # =============================================================================

  # UDP DNS 服务
  - type: udp_server
    args:
      entry: main_sequence
      listen: ":5333"

  # TCP DNS 服务
  - type: tcp_server
    args:
      entry: main_sequence
      listen: ":5333"
