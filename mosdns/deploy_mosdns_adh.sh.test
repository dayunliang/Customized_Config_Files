#!/bin/sh
###############################################################################
# MosDNS + ADH ä¸€é”®éƒ¨ç½²ï¼ˆé›†æˆ crun ä¿®å¤/æ³¨å†Œ + compose å¼ºåˆ¶ runtime: crunï¼‰
# é€‚ç”¨ï¼šAlpine Linuxï¼ŒDocker 29+/containerd 2.xï¼Œé»˜è®¤ä½¿ç”¨ docker compose v2
###############################################################################
set -e

# ===== åŸºæœ¬å˜é‡ =====
MOSDNS_DIR="${HOME}/mosdns"
ADH_CN_DIR="${HOME}/adh_cn"
ADH_GFW_DIR="${HOME}/adh_gfw"
CRONTAB_FILE="/etc/crontabs/root"
REPORT="/root/mosdns_adh_deploy_$(date +%Y%m%d_%H%M%S).log"

# ===== å½©è‰²è¾“å‡º =====
G='\033[32m'; R='\033[31m'; Y='\033[33m'; B='\033[34m'; N='\033[0m'
ok(){   printf "${G}âœ”${N} %s\n" "$*"; }
warn(){ printf "${Y}â–²${N} %s\n" "$*"; }
err(){  printf "${R}âœ˜${N} %s\n" "$*"; }
info(){ printf "${B}i${N} %s\n" "$*"; }

# ===== å°å·¥å…·å‡½æ•° =====
wait_sock() { # ç­‰å¾… docker.sock æœ€å¤š N ç§’
  N="${1:-20}"
  for _ in $(seq 1 "$N"); do
    [ -S /var/run/docker.sock ] && return 0
    sleep 1
  done
  return 1
}
restart_daemons() {
  rc-service docker stop >/dev/null 2>&1 || true
  rc-service containerd stop >/dev/null 2>&1 || true
  rm -rf /run/containerd/io.containerd.runtime.v2.task/moby/* >/dev/null 2>&1 || true
  rc-service containerd start >/dev/null 2>&1 || true
  rc-service docker start >/dev/null 2>&1 || true
  wait_sock 25
}
docker_info_brief() {
  docker info 2>/dev/null | awk '
    /Server Version|Default Runtime|Runtimes|Storage Driver|Backing Filesystem|Cgroup Version/ {print}
  '
}
# ç»™ compose æ–‡ä»¶æ³¨å…¥ `runtime: crun`ï¼ˆåœ¨ container_name æˆ– image è¡Œåæ’å…¥ï¼‰
inject_crun_runtime() {
  f="$1"
  [ -s "$f" ] || return 0
  if grep -q 'runtime:[[:space:]]*crun' "$f"; then
    return 0
  fi
  # ä¼˜å…ˆåœ¨ container_name åæ’
  if grep -q 'container_name:' "$f"; then
    awk '
      {print}
      /container_name:/ && !ins {print "    runtime: crun"; ins=1}
    ' "$f" > "$f.tmp" && mv "$f.tmp" "$f" && return 0
  fi
  # å¦åˆ™åœ¨ image åæ’
  if grep -q 'image:' "$f"; then
    awk '
      {print}
      /image:/ && !ins {print "    runtime: crun"; ins=1}
    ' "$f" > "$f.tmp" && mv "$f.tmp" "$f" && return 0
  fi
}

# ===== [1/14] APK æº =====
echo "[1/14] è®¾ç½® APK é•œåƒæºä¸ºä¸­ç§‘å¤§..."
if ! grep -q ustc /etc/apk/repositories 2>/dev/null; then
cat >/etc/apk/repositories <<-'EOF'
https://mirrors.ustc.edu.cn/alpine/latest-stable/main
https://mirrors.ustc.edu.cn/alpine/latest-stable/community
EOF
apk update
fi
ok "APK æºå·²å°±ç»ª"

# ===== [2/14] åŸºç¡€åŒ… =====
echo "[2/14] å®‰è£…åŸºç¡€åŒ…..."
apk add --no-cache open-vm-tools jq curl vim musl-locales musl-locales-lang less \
  net-tools iptables ip6tables c-ares nftables >/dev/null 2>&1 || true
rc-update add open-vm-tools default >/dev/null 2>&1 || true
rc-service open-vm-tools start >/dev/null 2>&1 || true
ok "åŸºç¡€åŒ…å®‰è£…å®Œæˆ"

# ===== [3/14] æœ¬åœ°åŒ–ï¼ˆå¯é€‰ï¼‰=====
echo "[3/14] é…ç½®ä¸­æ–‡ç¯å¢ƒä¸ Vim..."
cat >/etc/profile.d/locale.sh <<'EOF'
export LANG=zh_CN.UTF-8
export LC_CTYPE=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
EOF
chmod +x /etc/profile.d/locale.sh
. /etc/profile.d/locale.sh
cat >/etc/vim/vimrc <<'EOF'
set encoding=utf-8
set termencoding=utf-8
set fileencoding=utf-8
set fileencodings=ucs-bom,utf-8,default,latin1
EOF
ok "ä¸­æ–‡ç¯å¢ƒä¸ Vim å·²é…ç½®"

# ===== [4/14] Docker/Containerd/crun å®‰è£…ä¸æ³¨å†Œ =====
echo "[4/14] å®‰è£… Docker / containerd / crun / compose..."
apk add --no-cache docker containerd runc crun docker-cli docker-cli-buildx docker-cli-compose openrc >/dev/null 2>&1 || true
rc-update add containerd default >/dev/null 2>&1 || true
rc-update add docker default >/dev/null 2>&1 || true

# å†…æ ¸ / cgroup2 / bridge-nf
modprobe overlay 2>/dev/null || true
modprobe br_netfilter 2>/dev/null || true
mkdir -p /sys/fs/cgroup
mount | grep -q "type cgroup2" || mount -t cgroup2 none /sys/fs/cgroup 2>/dev/null || true
rc-update add cgroups default >/dev/null 2>&1 || true
rc-service cgroups start >/dev/null 2>&1 || true
sysctl -w net.bridge.bridge-nf-call-iptables=1  >/dev/null 2>&1 || true
sysctl -w net.bridge.bridge-nf-call-ip6tables=1 >/dev/null 2>&1 || true

# daemon.jsonï¼šé•œåƒåŠ é€Ÿå™¨ + æ³¨å†Œ crun å¹¶è®¾é»˜è®¤
echo "[5/14] é…ç½® Docker é•œåƒåŠ é€Ÿä¸é»˜è®¤ runtime..."
mkdir -p /etc/docker
[ -s /etc/docker/daemon.json ] || echo '{}' > /etc/docker/daemon.json
cp /etc/docker/daemon.json /etc/docker/daemon.json.bak.$(date +%Y%m%d%H%M%S)
jq '
  ."registry-mirrors"=[
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.nju.edu.cn",
    "https://docker.mirrors.sjtug.sjtu.edu.cn",
    "https://mirror.iscas.ac.cn"
  ]
  | ."default-runtime"="crun"
  | .runtimes = (.runtimes // {})
  | .runtimes.crun.path="/usr/bin/crun"
' /etc/docker/daemon.json > /etc/docker/daemon.json.new && mv /etc/docker/daemon.json.new /etc/docker/daemon.json

# containerd åŸºç¡€ configï¼ˆé»˜è®¤ runcï¼Œé¿å…å‘Šè­¦ï¼‰
[ -s /etc/containerd/config.toml ] || containerd config default >/etc/containerd/config.toml 2>/dev/null || true

echo "[6/14] é‡å¯ containerd / docker..."
restart_daemons || { err "dockerd æœªå°±ç»ª"; exit 1; }
ok "dockerd socket å°±ç»ª"
info "Docker ä¿¡æ¯ï¼š"
docker_info_brief || true

# ===== [7/14] æ¸…ç†ç¯å¢ƒï¼ˆç«¯å£/å®¹å™¨/è¿›ç¨‹ + ç›®å½•ï¼‰=====
echo "[7/14] æ¸…ç†æ—§å®¹å™¨å¹¶é‡Šæ”¾ç«¯å£ï¼ˆ53/54/55ï¼‰..."
PORTS="53 54 55"
TMP_CONTAINER=$(mktemp); TMP_PROCESS=$(mktemp)

for PORT in $PORTS; do
  docker ps --format '{{.ID}} {{.Names}} {{.Ports}}' | grep ":$PORT->" | while read ID NAME _; do
    echo "$PORT $ID $NAME" >> "$TMP_CONTAINER"
  done
done

for PORT in $PORTS; do
  netstat -tulpn 2>/dev/null | grep ":$PORT" | while read -r line; do
    proto=$(echo "$line" | awk '{print $1}')
    pid_info=$(echo "$line" | awk '{print $NF}')
    echo "$pid_info" | grep -qE '^[0-9]+/[^[:space:]]+$' || continue
    pid=$(echo "$pid_info" | cut -d'/' -f1)
    name=$(echo "$pid_info" | cut -d'/' -f2)
    [ "$name" = "docker-proxy" ] && docker ps | grep -q "$PORT" && continue
    echo "$PORT $proto $pid $name" >> "$TMP_PROCESS"
  done
done

if [ ! -s "$TMP_CONTAINER" ] && [ ! -s "$TMP_PROCESS" ]; then
  ok "æ— ç«¯å£å ç”¨"
else
  [ -s "$TMP_CONTAINER" ] && awk '{printf "  â†’ å®¹å™¨ %s (%s) ç›‘å¬ %s\n", $3, $2, $1}' "$TMP_CONTAINER"
  [ -s "$TMP_PROCESS" ] && awk '{printf "  â†’ è¿›ç¨‹ %-16s PID=%s å ç”¨ %s/%s\n", $4, $3, $1, $2}' "$TMP_PROCESS"
  # éäº¤äº’é»˜è®¤ç›´æ¥å¤„ç†
  [ -s "$TMP_CONTAINER" ] && sort -u "$TMP_CONTAINER" | awk '{print $2}' | sort -u | while read ID; do
    docker stop "$ID" >/dev/null 2>&1 || true
    docker rm "$ID"   >/dev/null 2>&1 || true
  done
  [ -s "$TMP_PROCESS" ] && awk '{print $3}' "$TMP_PROCESS" | sort -u | while read PID; do
    kill "$PID" 2>/dev/null || kill -9 "$PID" 2>/dev/null || true
  done
  ok "ç«¯å£å ç”¨å·²é‡Šæ”¾"
fi
rm -f "$TMP_CONTAINER" "$TMP_PROCESS"

# æ¸…ç†æ—§ç›®å½•
echo "ğŸ§¹ æ¸…ç†æ—§é…ç½®ç›®å½•..."
rm -rf "$MOSDNS_DIR" "$ADH_CN_DIR" "$ADH_GFW_DIR"
mkdir -p "$MOSDNS_DIR" "$ADH_CN_DIR/conf" "$ADH_CN_DIR/work" "$ADH_GFW_DIR/conf" "$ADH_GFW_DIR/work"
ok "ç¯å¢ƒæ¸…ç†å®Œæˆ"

# ===== [8/14] éƒ¨ç½² ADH_CN =====
echo "[8/14] éƒ¨ç½² adh_cn..."
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/conf/adh_cn.yaml \
  -o "$ADH_CN_DIR/conf/AdGuardHome.yaml"
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/adh_cn \
  -o "$ADH_CN_DIR/docker-compose.yaml"
# æ³¨å…¥ runtime: crun
inject_crun_runtime "$ADH_CN_DIR/docker-compose.yaml"
( cd "$ADH_CN_DIR" && docker compose down -v >/dev/null 2>&1 || true )
( cd "$ADH_CN_DIR" && docker compose up -d )
ok "adh_cn å·²å¯åŠ¨"

# ===== [9/14] éƒ¨ç½² ADH_GFW =====
echo "[9/14] éƒ¨ç½² adh_gfw..."
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/conf/adh_gfw.yaml \
  -o "$ADH_GFW_DIR/conf/AdGuardHome.yaml"
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/adh_gfw \
  -o "$ADH_GFW_DIR/docker-compose.yaml"
inject_crun_runtime "$ADH_GFW_DIR/docker-compose.yaml"
( cd "$ADH_GFW_DIR" && docker compose down -v >/dev/null 2>&1 || true )
( cd "$ADH_GFW_DIR" && docker compose up -d )
ok "adh_gfw å·²å¯åŠ¨"

# ===== [10/14] MosDNS èµ„æº =====
echo "[10/14] ä¸‹è½½ MosDNS compose ä¸ update.sh..."
cd "$MOSDNS_DIR"
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/mosdns \
  -o ./docker-compose.yaml
curl -fsSL https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/main/mosdns/update.sh \
  -o ./update.sh
chmod +x ./update.sh
# ç»™ mosdns compose æ³¨å…¥ runtime: crun
inject_crun_runtime "$MOSDNS_DIR/docker-compose.yaml"
./update.sh || true
ok "MosDNS èµ„æºå·²å‡†å¤‡"

# ===== [11/14] cron è‡ªåŠ¨æ›´æ–° =====
echo "[11/14] è®¾ç½® cron è‡ªåŠ¨æ›´æ–°..."
touch "$CRONTAB_FILE"
sed -i '\#cd '"$MOSDNS_DIR"' && ./update.sh#d' "$CRONTAB_FILE"
echo "0 4 * * 1 cd $MOSDNS_DIR && ./update.sh >> $MOSDNS_DIR/update.log 2>&1" >> "$CRONTAB_FILE"
ok "Cron è§„åˆ™å·²æ›´æ–°"

# ===== [12/14] è§„åˆ™ä¸ç©ºç™½åå• =====
echo "[12/14] ä¸‹è½½è§„åˆ™ä¸ç©ºç™½åå•..."
mkdir -p "$MOSDNS_DIR/rules-dat" "$MOSDNS_DIR/config/rule"
: > "$MOSDNS_DIR/rules-dat/geoip_private.txt"
: > "$MOSDNS_DIR/rules-dat/hosts.txt"
for f in config_custom.yaml dns.yaml dat_exec.yaml; do
  curl -fsSL "https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/main/mosdns/config/$f" -o "$MOSDNS_DIR/config/$f"
done
: > "$MOSDNS_DIR/config/rule/whitelist.txt"
: > "$MOSDNS_DIR/config/rule/greylist.txt"
ok "è§„åˆ™ä¸ç™½/ç°åå•å·²å°±ç»ª"

# ===== [13/14] å¯åŠ¨ MosDNS =====
echo "[13/14] å¯åŠ¨ MosDNS..."
cd "$MOSDNS_DIR"
docker compose up -d --force-recreate
ok "MosDNS å·²å¯åŠ¨"

# ===== [14/14] éªŒè¯ä¸æ±‡æ€» =====
echo "[14/14] éªŒè¯æœåŠ¡ä¸ç«¯å£..."
echo "â€”â€” docker ps â€”â€”"
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | sed -n '1,20p'

# ç«¯å£æ¢æµ‹ï¼ˆä»… TCPï¼‰
command -v nc >/dev/null 2>&1 && {
  nc -zv 127.0.0.1 81   >/dev/null 2>&1 && ok "ADH_CN UI 81 OK"     || warn "ADH_CN UI 81 æœªç›‘å¬"
  nc -zv 127.0.0.1 3001 >/dev/null 2>&1 && ok "ADH_CN å‘å¯¼ 3001 OK" || warn "ADH_CN å‘å¯¼ 3001 æœªç›‘å¬"
  nc -zv 127.0.0.1 54   >/dev/null 2>&1 && ok "ADH_CN DNS 54/TCP OK"|| warn "ADH_CN DNS 54/TCP æœªç›‘å¬"

  nc -zv 127.0.0.1 82   >/dev/null 2>&1 && ok "ADH_GFW UI 82 OK"     || warn "ADH_GFW UI 82 æœªç›‘å¬ï¼ˆå¦‚ä½ æ˜ å°„ 82ï¼‰"
  nc -zv 127.0.0.1 3002 >/dev/null 2>&1 && ok "ADH_GFW å‘å¯¼ 3002 OK" || warn "ADH_GFW å‘å¯¼ 3002 æœªç›‘å¬ï¼ˆå¦‚ä½ æ˜ å°„ 3002ï¼‰"
  nc -zv 127.0.0.1 55   >/dev/null 2>&1 && ok "ADH_GFW DNS 55/TCP OK"|| warn "ADH_GFW DNS 55/TCP æœªç›‘å¬"
} || true

echo "==== docker info (brief) ====" >> "$REPORT"
docker_info_brief >> "$REPORT" 2>&1 || true

ok "âœ… æ‰€æœ‰æœåŠ¡éƒ¨ç½²å®Œæˆ"
echo "ğŸ“Œ æŸ¥çœ‹ MosDNS æ—¥å¿—ï¼š  cd $MOSDNS_DIR && docker compose logs -f mosdns"
echo "ğŸ“Œ æŸ¥çœ‹ ADH_CN æ—¥å¿—ï¼š  cd $ADH_CN_DIR && docker compose logs -f"
echo "ğŸ“Œ æŸ¥çœ‹ ADH_GFW æ—¥å¿—ï¼š cd $ADH_GFW_DIR && docker compose logs -f"
echo "ğŸ§¾ æŠ¥å‘Šï¼š$REPORT"
