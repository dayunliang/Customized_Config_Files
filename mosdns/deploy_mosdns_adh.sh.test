#!/bin/sh
set -Eeuo pipefail

# ===== 可调参数 =====
RESET_CONFIG="${RESET_CONFIG:-0}"                       # 0=保留历史配置 1=清空重建 conf/work
FORCE_DISABLE_AGH_DHCP="${FORCE_DISABLE_AGH_DHCP:-1}"  # 1=启动前强制关闭 AGH DHCP

# 目录
MOSDNS_DIR="$HOME/mosdns"
ADH_CN_DIR="$HOME/adh_cn"
ADH_GFW_DIR="$HOME/adh_gfw"
CRONTAB_FILE="/etc/crontabs/root"

# 端口
PORT_CN_DNS=54
PORT_GFW_DNS=55
PORT_CN_WEB=30054
PORT_GFW_WEB=30055

log(){ printf "\033[1;32m[%s]\033[0m %s\n" "$(date +%H:%M:%S)" "$*"; }
warn(){ printf "\033[1;33m[%s]\033[0m %s\n" "$(date +%H:%M:%S)" "$*"; }
die(){ printf "\033[1;31m[%s]\033[0m %s\n" "$(date +%H:%M:%S)" "$*"; exit 1; }

# raw → jsDelivr
to_jsdelivr(){
  echo "$1" | sed -E '
    s#^https://raw\.githubusercontent\.com/([^/]+)/([^/]+)/refs/heads/([^/]+)/(.*)$#https://cdn.jsdelivr.net/gh/\1/\2@\3/\4#; t
    s#^https://raw\.githubusercontent\.com/([^/]+)/([^/]+)/([^/]+)/(.*)$#https://cdn.jsdelivr.net/gh/\1/\2@\3/\4#
  '
}

# 双重回退下载：GitHub Raw → jsDelivr
fetch(){
  url="$1"; shift
  jsd="$(to_jsdelivr "$url")"
  for u in "$url" "$jsd"; do
    [ -n "$u" ] || continue
    curl -fL --retry 3 --retry-delay 1 --connect-timeout 8 "$u" "$@" && return 0
  done
  return 1
}

ensure_dns_and_ca(){
  [ -s /etc/resolv.conf ] || printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" >/etc/resolv.conf
  apk info -e ca-certificates >/dev/null 2>&1 || apk add --no-cache ca-certificates >/dev/null 2>&1 || true
  update-ca-certificates >/dev/null 2>&1 || true
}

ensure_crun_default(){
  # 安装 docker/containerd/crun 及常用工具
  apk add --no-cache docker containerd crun jq net-tools curl vim musl-locales musl-locales-lang less open-vm-tools || true
  rc-update add open-vm-tools default || true
  rc-service open-vm-tools start || true

  # 写 daemon.json：设 crun 为默认并保留镜像加速
  mkdir -p /etc/docker
  if [ -f /etc/docker/daemon.json ]; then
    tmp=/etc/docker/daemon.json.tmp.$$
    jq '
      .runtimes = (.runtimes // {}) |
      .runtimes.crun = {"path": "/usr/bin/crun"} |
      ."default-runtime" = "crun" |
      ."registry-mirrors" = (."registry-mirrors" // [
        "https://docker.m.daocloud.io",
        "https://dockerproxy.com",
        "https://mirror.baidubce.com",
        "https://docker.nju.edu.cn",
        "https://docker.mirrors.sjtug.sjtu.edu.cn",
        "https://mirror.iscas.ac.cn"
      ])
    ' /etc/docker/daemon.json > "$tmp" && mv -f "$tmp" /etc/docker/daemon.json
  else
    cat >/etc/docker/daemon.json <<-'EOF'
{
  "runtimes": { "crun": { "path": "/usr/bin/crun" } },
  "default-runtime": "crun",
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.nju.edu.cn",
    "https://docker.mirrors.sjtug.sjtu.edu.cn",
    "https://mirror.iscas.ac.cn"
  ]
}
EOF
  fi

  # 避免 OpenRC 覆盖 config-file
  [ -f /etc/conf.d/docker ] && sed -i 's#--config-file=[^"]*##g' /etc/conf.d/docker || true

  # 重启并清理运行态
  rc-service docker stop || true
  rc-service containerd stop 2>/dev/null || true
  pkill -f containerd-shim 2>/dev/null || true
  rm -rf /run/containerd/* /var/run/docker/*

  rc-service containerd start 2>/dev/null || true
  rc-service docker start

  # 校验 & 最小容器自检
  docker info | grep -qi 'Default Runtime: crun' || {
    echo 'DOCKER_OPTS="--config-file=/etc/docker/daemon.json"' > /etc/conf.d/docker
    rc-service docker restart
  }
  docker info | grep -qi 'Default Runtime: crun' || die "默认运行时未切到 crun"
  docker run --rm alpine:3.20 echo ok >/dev/null 2>&1 || die "docker 最小容器自检失败"
}

cleanup_ports(){
  PORTS="53 54 55"
  log "[清理端口] 释放 53/54/55 ..."
  for P in $PORTS; do
    # 容器
    for ID in $(docker ps --format '{{.ID}} {{.Ports}}' | grep ":$P->" | awk '{print $1}' | sort -u); do
      docker stop "$ID" >/dev/null 2>&1 || true
      docker rm "$ID"   >/dev/null 2>&1 || true
    done
    # 本地进程（排除 docker-proxy，它会随容器清理）
    for PID in $(netstat -tulpn 2>/dev/null | grep ":$P " | awk '{print $NF}' | awk -F/ '/^[0-9]+\//{print $1}' | sort -u); do
      kill "$PID" 2>/dev/null || kill -9 "$PID" 2>/dev/null || true
    done
  done
}

prepare_dirs(){
  for D in "$MOSDNS_DIR" "$ADH_CN_DIR" "$ADH_GFW_DIR"; do
    [ "$RESET_CONFIG" = "1" ] && rm -rf "$D" || true
    mkdir -p "$D"
  done
}

disable_agh_dhcp(){
  yaml="$1"
  [ "$FORCE_DISABLE_AGH_DHCP" = "1" ] || return 0
  [ -f "$yaml" ] || return 0
  if grep -qE '^\s*dhcp:\s*$' "$yaml"; then
    sed -i '0,/^\s*enabled:\s*.*/s//  enabled: false/' "$yaml" || true
  else
    printf "\n# injected by deploy script\ndhcp:\n  enabled: false\n" >> "$yaml"
  fi
}

compose_up(){
  dir="$1"; name="$2"; want_dns_port="$3"; want_web_port="$4"

  # 先确保目录存在，再下载
  mkdir -p "$dir/work" "$dir/conf"

  if [ "$name" = "adh_cn" ]; then
    fetch https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/conf/adh_cn.yaml -o "$dir/conf/AdGuardHome.yaml" || die "下载 adh_cn.yaml 失败"
    fetch https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/adh_cn -o "$dir/docker-compose.yaml" || die "下载 adh_cn compose 失败"
  else
    fetch https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/conf/adh_gfw.yaml -o "$dir/conf/AdGuardHome.yaml" || die "下载 adh_gfw.yaml 失败"
    fetch https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/adh_gfw -o "$dir/docker-compose.yaml" || die "下载 adh_gfw compose 失败"
  fi

  # 关闭 DHCP（可配）
  disable_agh_dhcp "$dir/conf/AdGuardHome.yaml"

  # 端口提示（不强改，避免误伤你的仓库写法）
  if ! grep -q "${want_dns_port}:53" "$dir/docker-compose.yaml"; then
    warn "$name 的 docker-compose.yaml 未发现端口映射 ${want_dns_port}:53，请确认仓库端口配置是否与你规划一致。"
  fi
  ( cd "$dir" && docker-compose up -d --force-recreate )
}

deploy_mosdns(){
  mkdir -p "$MOSDNS_DIR"
  fetch https://raw.githubusercontent.com/dayunliang/Customized_Config_Files/refs/heads/main/mosdns/docker-compose/mosdns -o "$MOSDNS_DIR/docker-compose.yaml" || die "下载 mosdns compose 失败"

  # 加强版 update.sh（带回退）
  cat > "$MOSDNS_DIR/update.sh" <<'UPDATE'
#!/bin/sh
set -eu
MOSDNS_DIR="${MOSDNS_DIR:-$HOME/mosdns}"
RULES_DAT_DIR="$MOSDNS_DIR/rules-dat"
mkdir -p "$RULES_DAT_DIR"
command -v curl >/dev/null 2>&1 || apk add --no-cache curl >/dev/null 2>&1 || true
apk info -e ca-certificates >/dev/null 2>&1 || apk add --no-cache ca-certificates >/dev/null 2>&1 || true
update-ca-certificates >/dev/null 2>&1 || true
to_jsdelivr(){ echo "$1" | sed -E 's#^https://raw\.githubusercontent\.com/([^/]+)/([^/]+)/refs/heads/([^/]+)/(.*)$#https://cdn.jsdelivr.net/gh/\1/\2@\3/\4#; t; s#^https://raw\.githubusercontent\.com/([^/]+)/([^/]+)/([^/]+)/(.*)$#https://cdn.jsdelivr.net/gh/\1/\2@\3/\4#'; }
fetch(){ url="$1"; shift; jsd="$(to_jsdelivr "$url")"; for u in "$url" "$jsd"; do curl -fL --retry 3 --retry-delay 1 --connect-timeout 8 "$u" "$@" && exit 0; done; exit 1; }
LIST=$(cat << 'EOF'
https://raw.githubusercontent.com/17mon/china_ip_list/refs/heads/master/china_ip_list.txt geoip_cn.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt geosite_category-ads-all.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt geosite_geolocation-!cn.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt geosite_cn.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt geosite_gfw.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/china-list.txt geosite_cn_extra.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/apple-cn.txt geosite_cn_apple.txt
https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/google-cn.txt geosite_cn_google.txt
EOF
)
TOTAL=$(printf "%s\n" "$LIST" | wc -l | tr -d ' ')
i=1
printf "%s\n" "$LIST" | while IFS=' ' read -r url name; do
  [ -n "$url" ] || continue
  echo "[$i/$TOTAL] $name ..."
  if fetch "$url" -o "$RULES_DAT_DIR/$name"; then
    echo "  -> saved"
  else
    echo "  !! failed"
  fi
  i=$((i+1))
done
echo "All lists updated in ${RULES_DAT_DIR}."
UPDATE
  chmod +x "$MOSDNS_DIR/update.sh"

  ( cd "$MOSDNS_DIR" && "$MOSDNS_DIR/update.sh" )
  ( cd "$MOSDNS_DIR" && docker-compose up -d --force-recreate )
}

# ===== 主流程 =====
log "[1/14] 设置 APK 源（USTC）"
grep -q ustc /etc/apk/repositories 2>/dev/null || {
  cat >/etc/apk/repositories <<-'EOF'
https://mirrors.ustc.edu.cn/alpine/latest-stable/main
https://mirrors.ustc.edu.cn/alpine/latest-stable/community
EOF
  apk update || true
}
ensure_dns_and_ca

log "[2/14] 安装并配置 Docker + crun"
ensure_crun_default

log "[3/14] 释放端口占用"
cleanup_ports

log "[4/14] 准备目录（RESET_CONFIG=${RESET_CONFIG})"
prepare_dirs

log "[5/14] 部署 adh_cn"
compose_up "$ADH_CN_DIR" "adh_cn" "$PORT_CN_DNS" "$PORT_CN_WEB"

log "[6/14] 部署 adh_gfw"
compose_up "$ADH_GFW_DIR" "adh_gfw" "$PORT_GFW_DNS" "$PORT_GFW_WEB"

log "[7/14] 部署 mosdns"
deploy_mosdns

log "[8/14] 写入 cron（每周一 04:00 自更新）"
touch "$CRONTAB_FILE"
sed -i '\#cd '"$MOSDNS_DIR"' && ./update.sh#d' "$CRONTAB_FILE"
echo "0 4 * * 1 cd $MOSDNS_DIR && ./update.sh >> $MOSDNS_DIR/update.log 2>&1" >> "$CRONTAB_FILE"

log "✅ 部署完成；健康检查："
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
