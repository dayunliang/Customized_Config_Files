#!/bin/bash
# ===========================================================================
# Lean OpenWrt å®šåˆ¶æ–‡ä»¶ä¸€é”®éƒ¨ç½²è„šæœ¬
# åŠŸèƒ½ï¼š
#   1. è‡ªåŠ¨æ£€æµ‹æ˜¯å¦åœ¨ OpenWrt æºç æ ¹ç›®å½•è¿è¡Œï¼Œå¦åˆ™å¯é€‰æ‹©è‡ªåŠ¨ git clone å¹¶è¿›å…¥
#   2. å…‹éš†è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä»“åº“ï¼ˆREPO_URLï¼‰ï¼Œå¹¶å°†æ–‡ä»¶éƒ¨ç½²åˆ°å¯¹åº”è·¯å¾„
#   3. å¯¹å·²å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œè‡ªåŠ¨å¤‡ä»½ï¼ˆåŠ æ—¶é—´æˆ³åç¼€ï¼‰
#   4. è‡ªåŠ¨æ£€æµ‹å¹¶è¿½åŠ  luci feedï¼ˆé¿å… po2lmo ç¼ºå¤±ï¼‰
#   5. æ‰§è¡Œ feeds update/install + make defconfig
#   6. å¼ºåˆ¶ç¼–è¯‘ po2lmo å·¥å…·ï¼ˆé¿å… default-settings ç¼–è¯‘æ—¶æŠ¥é”™ï¼‰
#   7. å¯é€‰æ‰§è¡Œ make download å¹¶å¾ªç¯æ ¡éªŒä¸‹è½½å®Œæ•´æ€§
#   8. æœ€ç»ˆè¾“å‡ºæ‰§è¡Œæ‘˜è¦å’Œå¤‡ä»½æ¸…å•
# ä½œè€…ï¼šhttps://github.com/dayunliang
# ===========================================================================

set -e  # é‡åˆ°ä»»ä½•å‘½ä»¤è¿”å›é0çŠ¶æ€ï¼Œç«‹åˆ»é€€å‡ºï¼Œé˜²æ­¢é”™è¯¯ç»§ç»­ä¼ æ’­

# ==== [0] ç¯å¢ƒæ£€æŸ¥ ====
if [ -z "$BASH_VERSION" ]; then
    echo "â— æœ¬è„šæœ¬å¿…é¡»åœ¨ bash ç¯å¢ƒè¿è¡Œï¼ˆsh ä¸è¡Œï¼‰ï¼Œè¯·ç”¨ bash æ‰§è¡Œï¼"
    exit 1
fi

# ==== [1] ç¡®è®¤å½“å‰æ˜¯å¦åœ¨ OpenWrt æºç æ ¹ç›®å½• ====
# æ£€æŸ¥ scripts/feeds è„šæœ¬ å’Œ package ç›®å½•æ˜¯å¦å­˜åœ¨
# å¦‚æœä¸å­˜åœ¨ï¼Œå°±æç¤ºç”¨æˆ·æ˜¯å¦éœ€è¦è‡ªåŠ¨å…‹éš†æºç 
if [ ! -f "./scripts/feeds" ] || [ ! -d "./package" ]; then
    echo "ğŸ” æœªæ£€æµ‹åˆ° OpenWrt æºç æ ¹ç›®å½•ã€‚"
    cd ~
    echo "ğŸ“ å·²åˆ‡æ¢åˆ°ç”¨æˆ·ä¸»ç›®å½•: $PWD"
    read -p "æ˜¯å¦éœ€è¦è‡ªåŠ¨ clone OpenWrt ä»“åº“å¹¶è¿›å…¥è¯¥ç›®å½•ï¼Ÿ(y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # è®©ç”¨æˆ·é€‰æ‹© OpenWrt ä»“åº“ URLï¼Œé»˜è®¤æ˜¯ Lean æº
        read -p "è¯·è¾“å…¥ OpenWrt ä»“åº“ URL (é»˜è®¤: https://github.com/coolsnowwolf/lede.git): " repo_url
        repo_url=${repo_url:-https://github.com/coolsnowwolf/lede.git}

        # è®©ç”¨æˆ·é€‰æ‹©å…‹éš†åˆ°çš„ç›®å½•å
        read -p "è¯·è¾“å…¥ç›®æ ‡ç›®å½•å (é»˜è®¤: lede): " target_dir
        target_dir=${target_dir:-lede}

        echo "ğŸŒ æ­£åœ¨å…‹éš† $repo_url åˆ° $target_dir ..."
        git clone --depth=1 "$repo_url" "$target_dir" || {
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL æˆ–ç½‘ç»œã€‚"
            exit 1
        }
        cd "$target_dir"
        echo "âœ… å·²è¿›å…¥ç›®å½• $(pwd)ï¼Œç»§ç»­æ‰§è¡Œè„šæœ¬ã€‚"
    else
        # ç”¨æˆ·æ‹’ç»è‡ªåŠ¨ cloneï¼Œåˆ™é€€å‡ºå¹¶ç»™å‡ºæç¤º
        script_name=$(basename "$0")
        echo
        echo "è¯·æ‰‹åŠ¨ clone å¹¶è¿›å…¥æºç ç›®å½•åå†æ‰§è¡Œè„šæœ¬ï¼š"
        echo "  git clone https://github.com/coolsnowwolf/lede.git"
        echo "  cd lede"
        echo "  ./$script_name"
        exit 1
    fi
fi

# ==== [2] åŸºæœ¬å˜é‡å®šä¹‰ ====
REPO_URL="https://github.com/dayunliang/Customized_Config_Files.git" # è‡ªå®šä¹‰é…ç½®ä»“åº“
TMP_DIR=$(mktemp -d)    # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå…‹éš†é…ç½®ä»“åº“
TS=$(date +%Y%m%d-%H%M%S) # æ—¶é—´æˆ³ï¼Œç”¨äºå¤‡ä»½æ–‡ä»¶å‘½å
declare -a BACKUP_LIST  # ç”¨äºè®°å½•å¤‡ä»½çš„æ–‡ä»¶è·¯å¾„

# ==== [3] å…‹éš†å®šåˆ¶é…ç½®ä»“åº“ ====
echo "1. å…‹éš†è‡ªå®šä¹‰æ–‡ä»¶ä»“åº“åˆ°ä¸´æ—¶ç›®å½• $TMP_DIR ..."
if ! git clone --depth=1 "$REPO_URL" "$TMP_DIR"; then
    echo "âŒ å…‹éš†ä»“åº“å¤±è´¥ï¼š$REPO_URL"
    exit 1
fi

# ==== [4] æ–‡ä»¶å¤åˆ¶å‡½æ•°ï¼ˆå¸¦è‡ªåŠ¨å¤‡ä»½æœºåˆ¶ï¼‰ ====
safe_cp() {
    src="$1"  # æºæ–‡ä»¶è·¯å¾„
    dst="$2"  # ç›®æ ‡æ–‡ä»¶è·¯å¾„
    if [ -f "$dst" ]; then
        backup_name="$dst.bak.$TS"   # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
        cp -v "$dst" "$backup_name"  # å¤‡ä»½åŸæ–‡ä»¶
        BACKUP_LIST+=("$backup_name") # è®°å½•å¤‡ä»½è·¯å¾„
    fi
    cp -vf "$src" "$dst" # è¦†ç›–å¤åˆ¶æ–°æ–‡ä»¶
}

# ==== [5] éƒ¨ç½²æ–‡ä»¶å‡½æ•°ï¼ˆå¸¦ç¼ºå¤±æ£€æµ‹ï¼‰ ====
deploy_file() {
    desc="$1" # æ–‡ä»¶æè¿°
    src="$2"  # æºè·¯å¾„
    dst="$3"  # ç›®æ ‡è·¯å¾„
    if [ ! -f "$src" ]; then
        echo "âŒ ç¼ºå¤±æ–‡ä»¶ [$desc]ï¼š$src"
        exit 1
    fi
    mkdir -p "$(dirname "$dst")" # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    safe_cp "$src" "$dst"        # è°ƒç”¨ safe_cp å¤åˆ¶
}

# ==== [6] éƒ¨ç½²å®šåˆ¶é…ç½®æ–‡ä»¶ ====
echo "2. åˆ†å‘è‡ªå®šä¹‰é…ç½®æ–‡ä»¶..."
# ä»¥ä¸‹æ‰€æœ‰ deploy_file è°ƒç”¨ï¼Œä¾æ¬¡å°† TMP_DIR ä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ° OpenWrt å¯¹åº”è·¯å¾„

deploy_file ".config" "$TMP_DIR/Lean/config" "./.config"
echo "ğŸ“¦ .config å·²éƒ¨ç½²"

deploy_file "feeds.conf.default" "$TMP_DIR/Lean/feeds.conf.default" "./feeds.conf.default"
deploy_file "zzz-default-settings" "$TMP_DIR/Lean/zzz-default-settings" "./package/lean/default-settings/files/zzz-default-settings"

deploy_file "back-route-checkenv.sh" "$TMP_DIR/Lean/files/usr/bin/back-route-checkenv.sh" "./files/usr/bin/back-route-checkenv.sh"
deploy_file "back-route-complete.sh" "$TMP_DIR/Lean/files/usr/bin/back-route-complete.sh" "./files/usr/bin/back-route-complete.sh"
deploy_file "back-route-cron.sh" "$TMP_DIR/Lean/files/usr/bin/back-route-cron.sh" "./files/usr/bin/back-route-cron.sh"
chmod +x ./files/usr/bin/back-route-*.sh || true # ç»™è„šæœ¬åŠ æ‰§è¡Œæƒé™

deploy_file "IPSec é…ç½®æ–‡ä»¶" "$TMP_DIR/Lean/files/etc/ipsec.conf" "./files/etc/ipsec.conf"
deploy_file "IPSec å¯†ç æ–‡ä»¶" "$TMP_DIR/Lean/files/etc/ipsec.secrets" "./files/etc/ipsec.secrets"
deploy_file "IPSec WEB é…ç½®" "$TMP_DIR/Lean/files/etc/config/luci-app-ipsec-server" "./files/etc/config/luci-app-ipsec-server"

deploy_file "Openclash è‡ªå®šä¹‰è§„åˆ™" "$TMP_DIR/Lean/files/etc/config/openclash" "./files/etc/config/openclash"
deploy_file "Openclash è§„åˆ™é™„åŠ " "$TMP_DIR/Lean/files/etc/openclash/custom/openclash_custom_rules.list" "./files/etc/openclash/custom/openclash_custom_rules.list"
deploy_file "Openclash ç¬¬ä¸‰æ–¹è§„åˆ™é›†" "$TMP_DIR/Lean/files/usr/share/openclash/res/rule_providers.list" "./files/usr/share/openclash/res/rule_providers.list"

deploy_file "Openclash DNS false ä¿®æ”¹è„šæœ¬" "$TMP_DIR/Lean/files/etc/openclash/dns_enable_false.sh" "./files/etc/openclash/dns_enable_false.sh"
chmod +x ./files/etc/openclash/dns_enable_false.sh || true
deploy_file "Openclash æœåŠ¡å™¨èŠ‚ç‚¹é…ç½®" "$TMP_DIR/Lean/files/usr/share/openclash/yml_proxys_set.sh" "./files/usr/share/openclash/yml_proxys_set.sh"
chmod +x ./files/usr/share/openclash/yml_proxys_set.sh || true

deploy_file "ShadowSocksR Plus+ é…ç½®æ–‡ä»¶" "$TMP_DIR/Lean/files/etc/config/shadowsocksr" "./files/etc/config/shadowsocksr"
deploy_file "Turbo ACC ç½‘ç»œåŠ é€Ÿè®¾ç½®" "$TMP_DIR/Lean/files/etc/config/turboacc" "./files/etc/config/turboacc"
deploy_file "root è®¡åˆ’ä»»åŠ¡" "$TMP_DIR/Lean/files/etc/crontabs/root" "./files/etc/crontabs/root"

# ==== [7] æ¸…ç†ä¸´æ—¶ç›®å½• ====
echo "4. æ¸…ç†ä¸´æ—¶ç›®å½• $TMP_DIR"
rm -rf "$TMP_DIR"

# ==== [8] è‡ªåŠ¨æ£€æŸ¥ luci feedï¼ˆé˜²æ­¢ po2lmo ç¼ºå¤±ï¼‰ ====
if ! grep -qE '^src-git[[:space:]]+luci[[:space:]]+' feeds.conf.default; then
    echo "âš ï¸  feeds.conf.default æœªæ£€æµ‹åˆ° luci æºï¼Œè‡ªåŠ¨è¿½åŠ ..."
    echo "src-git luci https://github.com/coolsnowwolf/luci" >> feeds.conf.default
else
    echo "âœ… æ£€æµ‹åˆ° luci æºï¼Œæ— éœ€è¿½åŠ "
fi

# ä»…æ›´æ–° luci feedï¼Œå®‰è£… luci-baseï¼ˆpo2lmo åœ¨è¿™é‡Œï¼‰
./scripts/feeds update luci
./scripts/feeds install luci-base

# ==== [9] å…¨é‡ feeds æ›´æ–°å’Œå®‰è£… + defconfig ====
echo "ğŸ› ï¸ æ„å»ºå‰å‡†å¤‡ï¼šfeeds update/install + make defconfig"
./scripts/feeds update -a
./scripts/feeds install -a
make defconfig

# ==== [10] å¼ºåˆ¶ç¼–è¯‘ po2lmoï¼ˆé¿å… default-settings ç¼–è¯‘æ—¶æŠ¥é”™ï¼‰ ====
echo "ğŸ› ï¸ æ­£åœ¨ç¼–è¯‘ po2lmo å·¥å…·..."
if ! make package/feeds/luci/luci-base/host/compile V=s; then
    echo "âŒ po2lmo ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ golang ç‰ˆæœ¬æˆ– feeds ä¾èµ–"
    exit 1
fi

# ==== [11] å¯é€‰æºç é¢„ä¸‹è½½ ====
read -p "ğŸ§ æ˜¯å¦é¦–æ¬¡æ„å»ºï¼Ÿéœ€è¦é¢„ä¸‹è½½æºç åŒ…ï¼Ÿ(y/N): " is_first
if [[ "$is_first" =~ ^[Yy]$ ]]; then
    echo "ğŸ“¥ æ­£åœ¨é¢„ä¸‹è½½æºç åŒ…..."
    while true; do
        make download -j8 V=s
        broken=$(find dl -size -1024c) # æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½ä¸å®Œæ•´çš„æ–‡ä»¶
        if [ -z "$broken" ]; then
            echo "âœ… æºç åŒ…ä¸‹è½½å®Œæ•´"
            break
        else
            echo "âš ï¸ æ£€æµ‹åˆ°ä¸å®Œæ•´æ–‡ä»¶ï¼Œé‡æ–°ä¸‹è½½"
            echo "$broken"
            find dl -size -1024c -exec rm -f {} \;
        fi
    done
else
    echo "âœ… è·³è¿‡é¢„ä¸‹è½½ï¼Œå»ºè®®æ‰§è¡Œï¼šmake -j\$(nproc) V=s"
fi

# ==== [12] è¾“å‡ºå¤‡ä»½æ¸…å• ====
if [ ${#BACKUP_LIST[@]} -gt 0 ]; then
    echo "ğŸ—‚ï¸ æœ¬æ¬¡è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶ï¼š"
    for f in "${BACKUP_LIST[@]}"; do echo "  $f"; done
else
    echo "ğŸ—‚ï¸ æ— éœ€å¤‡ä»½ï¼šæœªæ£€æµ‹åˆ°åŒåæ–‡ä»¶"
fi

# ==== [13] æ‰§è¡Œæ­¥éª¤æ€»ç»“ ====
echo "ğŸ“‹ æœ¬æ¬¡æ‰§è¡Œå…³é”®æ­¥éª¤ï¼š"
echo "-------------------------------------------------------"
echo "âœ… éƒ¨ç½²å®šåˆ¶æ–‡ä»¶"
echo "âœ… è‡ªåŠ¨å¤‡ä»½å·²æœ‰é…ç½®"
echo "âœ… ä¸‹è½½ OpenClash Provider è§„åˆ™"
echo "âœ… æ‰§è¡Œ feeds update/install & make defconfig"
echo "âœ… ï¼ˆå¯é€‰ï¼‰é¢„ä¸‹è½½æºç åŒ…å¹¶æ ¡éªŒ"
echo "-------------------------------------------------------"

# ==== [14] æœ€ç»ˆæç¤º ====
echo "ğŸš€ æ‰€æœ‰é…ç½®éƒ¨ç½²å’Œæ„å»ºå‡†å¤‡å®Œæˆï¼"
echo "ğŸ“‚ å½“å‰ç›®å½•ï¼š$(pwd)"
echo "ğŸ“ å»ºè®®ï¼šmake -j\$(nproc) V=s"
