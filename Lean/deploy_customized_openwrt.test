#!/bin/bash
# ===========================================================================
# Lean OpenWrt å®šåˆ¶æ–‡ä»¶ä¸€é”®éƒ¨ç½²è„šæœ¬ã€é€è¡Œè¯¦è§£ç‰ˆã€‘
#
# åŠŸèƒ½ï¼š
#   1. æ£€æŸ¥å½“å‰æ˜¯å¦å¤„äº OpenWrt æºç æ ¹ç›®å½•
#   2. å¦‚æœä¸åœ¨æºç æ ¹ç›®å½•ï¼Œæ”¯æŒè‡ªåŠ¨ git clone è¿›å…¥
#   3. å…‹éš†è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ä»“åº“ï¼ˆREPO_URLï¼‰ï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°æŒ‡å®šè·¯å¾„
#   4. å¯¹å·²å­˜åœ¨çš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œå¤‡ä»½ï¼ˆåŠ æ—¶é—´æˆ³åç¼€ï¼Œé˜²æ­¢è¦†ç›–ä¸¢å¤±ï¼‰
#   5. è‡ªåŠ¨æ£€æµ‹ luci feedï¼Œé¿å… po2lmo å·¥å…·ç¼ºå¤±
#   6. æ‰§è¡Œ feeds update/install + make defconfig
#   7. å¼ºåˆ¶ç¼–è¯‘ po2lmoï¼ˆè§£å†³ default-settings ç¼–è¯‘æ—¶æŠ¥é”™é—®é¢˜ï¼‰
#   8. é¦–æ¬¡æ„å»ºå¯é€‰æ‰§è¡Œ make download å¹¶å¾ªç¯æ ¡éªŒä¸‹è½½å®Œæ•´æ€§
#   9. åœ¨å¤åˆ¶å‰æ³¨å…¥ WireGuard ç§é’¥åˆ°æ¨¡æ¿ï¼ˆæˆ–ç”Ÿæˆ uci-defaults å…œåº•ï¼‰
#  10. è¾“å‡ºæ‰§è¡Œæ‘˜è¦å’Œå¤‡ä»½æ¸…å•
# ä½œè€…ï¼šhttps://github.com/dayunliang
# ===========================================================================

set -e  # é‡åˆ°ä»»ä½•å‘½ä»¤å‡ºé”™ç«‹å³é€€å‡ºï¼ˆé˜²æ­¢é”™è¯¯ç»§ç»­æ‰§è¡Œï¼‰

# ==== [1] ç¯å¢ƒæ£€æŸ¥ ====
if [ -z "$BASH_VERSION" ]; then
    echo "â— å¿…é¡»åœ¨ bash ç¯å¢ƒä¸‹æ‰§è¡Œæ­¤è„šæœ¬ï¼Œsh ç¯å¢ƒä¸æ”¯æŒï¼"
    exit 1
fi

# ==== [2] æ£€æŸ¥æ˜¯å¦åœ¨ OpenWrt æºç æ ¹ç›®å½• ====
# åˆ¤å®šä¾æ®ï¼šå¿…é¡»åŒæ—¶å­˜åœ¨ scripts/feeds æ–‡ä»¶å’Œ package ç›®å½•

# spinner å‡½æ•°ï¼šæ˜¾ç¤ºè½¬åŠ¨æç¤ºç¬¦
show_spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while ps -p $pid > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf " [%c] æ­£åœ¨æ¸…ç©ºç›®å½•..." "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\r%-40s\r" " "   # æ¸…ç©ºæ•´è¡Œé¿å…æ®‹ç•™
    done
}

if [ ! -f "./scripts/feeds" ] || [ ! -d "./package" ]; then
    echo "ğŸ” æœªæ£€æµ‹åˆ° OpenWrt æºç æ ¹ç›®å½•ã€‚"
    read -p "æ˜¯å¦è‡ªåŠ¨ clone OpenWrt ä»“åº“å¹¶è¿›å…¥ï¼Ÿ(y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        read -p "è¯·è¾“å…¥ OpenWrt ä»“åº“ URL (é»˜è®¤: https://github.com/coolsnowwolf/lede.git): " repo_url
        repo_url=${repo_url:-https://github.com/coolsnowwolf/lede.git}

        read -p "è¯·è¾“å…¥ç›®æ ‡ç›®å½•å (é»˜è®¤: lede): " target_dir
        target_dir=${target_dir:-lede}

        if [ -d "$target_dir" ]; then
            echo "âš ï¸ ç›®å½• $target_dir å·²å­˜åœ¨ï¼Œè¿›å…¥è¯¥ç›®å½•..."
            cd "$target_dir"

            if [ -z "$(ls -A .)" ]; then
                echo "ğŸŒ ç›®å½•ä¸ºç©ºï¼Œæ­£åœ¨å…‹éš† $repo_url ..."
                git clone --depth=1 "$repo_url" . || { echo "âŒ å…‹éš†å¤±è´¥"; exit 1; }
            else
                read -p "âš ï¸ å½“å‰ç›®å½•éç©ºï¼Œæ˜¯å¦æ¸…ç©ºåå†å…‹éš†ï¼Ÿ(y/N): " clear_confirm
                if [[ "$clear_confirm" =~ ^[Yy]$ ]]; then
                    (rm -rf ./* ./.??* ) &
                    pid=$!
                    show_spinner $pid
                    wait $pid
                    echo "âœ… ç›®å½•å·²æ¸…ç©º"
                    echo "ğŸŒ å¼€å§‹å…‹éš† $repo_url ..."
                    git clone --depth=1 "$repo_url" . || { echo "âŒ å…‹éš†å¤±è´¥"; exit 1; }
                else
                    if [ ! -f "./scripts/feeds" ] || [ ! -d "./package" ]; then
                        echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯æœ‰æ•ˆçš„ OpenWrt æºç ç›®å½•ï¼Œæ— æ³•ç»§ç»­"
                        exit 1
                    fi
                    echo "â¡ï¸ è·³è¿‡ git cloneï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤..."
                fi
            fi
        else
            echo "ğŸŒ æ­£åœ¨å…‹éš† $repo_url åˆ° $target_dir ..."
            git clone --depth=1 "$repo_url" "$target_dir" || { echo "âŒ å…‹éš†å¤±è´¥"; exit 1; }
            cd "$target_dir"
        fi
        echo "âœ… å·²è¿›å…¥æºç ç›®å½•ï¼š$(pwd)"
    else
        echo "âŒ è¯·å…ˆæ‰‹åŠ¨ä¸‹è½½æºç å†è¿è¡Œæœ¬è„šæœ¬"
        echo "ç¤ºä¾‹ï¼š"
        echo "  git clone https://github.com/coolsnowwolf/lede.git"
        echo "  cd lede"
        echo "  bash $0"
        exit 1
    fi
fi

# ==== [3.1] åŸºæœ¬å˜é‡ ====
REPO_URL="https://github.com/dayunliang/Customized_Config_Files.git" # é…ç½®æ–‡ä»¶ä»“åº“
TMP_DIR=$(mktemp -d)    # ä¸´æ—¶ç›®å½•ï¼ˆè„šæœ¬ç»“æŸä¼šåˆ é™¤ï¼‰
TS=$(date +%Y%m%d-%H%M%S) # å½“å‰æ—¶é—´æˆ³ï¼Œç”¨äºå¤‡ä»½æ–‡ä»¶å‘½å
declare -a BACKUP_LIST  # æ•°ç»„ï¼Œç”¨äºè®°å½•å¤‡ä»½æ–‡ä»¶è·¯å¾„

# ==== [3.2] å…‹éš†å®šåˆ¶é…ç½®æ–‡ä»¶ä»“åº“ ====
echo "1. å…‹éš†å®šåˆ¶é…ç½®ä»“åº“åˆ°ä¸´æ—¶ç›®å½• $TMP_DIR ..."
if ! git clone --depth=1 "$REPO_URL" "$TMP_DIR"; then
    echo "âŒ å…‹éš†ä»“åº“å¤±è´¥ï¼š$REPO_URL"
    exit 1
fi

# ==== [4] ç¼–è¯‘ç‰ˆæœ¬é€‰æ‹©é€»è¾‘ ====
echo
echo "è¯·é€‰æ‹©è¦éƒ¨ç½²çš„ç¼–è¯‘ç‰ˆæœ¬ï¼š"
echo " 1) Beverly"
echo " 2) Riviera"
echo " 3) DOITCHINA"
read -p "è¯·è¾“å…¥æ•°å­— (1-3): " compile_choice

case "$compile_choice" in
  1) COMPILE_NAME="Beverly" ;;
  2) COMPILE_NAME="Riviera" ;;
  3) COMPILE_NAME="DOITCHINA" ;;
  *) echo "âŒ æ— æ•ˆé€‰æ‹©ï¼š$compile_choice"; exit 1 ;;
esac
echo "å·²é€‰æ‹©ç¼–è¯‘ç‰ˆæœ¬ï¼š$COMPILE_NAME"
echo

# ==== [5] å¤åˆ¶ä¸ç»Ÿè®¡ï¼ˆä¿ç•™å¤‡ä»½ï¼‰ ====
__DEPLOY_HITS=""
__DEPLOY_SKIPS=""

__hit()  { __DEPLOY_HITS="${__DEPLOY_HITS}${1}\n"; }
__skip() { __DEPLOY_SKIPS="${__DEPLOY_SKIPS}${1}\n"; }

safe_cp() {
  src="$1"
  dst="$2"
  if [ -f "$dst" ]; then
    backup_name="$dst.bak.$TS"
    cp -v "$dst" "$backup_name"
    BACKUP_LIST+=("$backup_name")
  fi
  mkdir -p "$(dirname "$dst")"
  cp -vf "$src" "$dst"
}

# æºä¸ç›®æ ‡æ ¹ç›®å½•
SRC_ROOT="${TMP_DIR}/Lean/files"   # overlay æºï¼ˆæŒ‰ç›¸å¯¹è·¯å¾„éƒ¨ç½²ï¼‰
DST_ROOT="./files"                 # OpenWrt overlay ç›®æ ‡æ ¹

# ==== [6] éƒ¨ç½²å‡½æ•°ï¼ˆç¼ºå¤±ä¹Ÿè§†ä¸ºæˆåŠŸï¼‰ ====

# 6.1 éƒ¨ç½² overlay æ–‡ä»¶ï¼šä¸¤å±‚é€‰æ‹©ï¼ˆ<rel>.<COMPILE_NAME> â†’ <rel>ï¼‰ï¼Œå¹¶ chmod
# ç”¨æ³•ï¼šdeploy_file "usr/bin/back-route-complete.sh" "755"
deploy_file() {
  rel="$1"
  mode="${2:-644}"
  site_src="${SRC_ROOT}/${rel}.${COMPILE_NAME}"
  def_src="${SRC_ROOT}/${rel}"
  dst="${DST_ROOT}/${rel}"

  if [ -f "${site_src}" ]; then
    echo "[DEPLOY] ${site_src} -> ${dst}"
    safe_cp "${site_src}" "${dst}"
    chmod "${mode}" "${dst}" || true
    __hit "${rel} (site=${COMPILE_NAME})"
  elif [ -f "${def_src}" ]; then
    echo "[DEPLOY] ${def_src} -> ${dst}"
    safe_cp "${def_src}" "${dst}"
    chmod "${mode}" "${dst}" || true
    __hit "${rel} (default)"
  else
    echo "[SKIP_OK] ${rel} (no site/default needed)"
    __skip "${rel}"
  fi
  return 0
}

# 6.2 éƒ¨ç½²â€œä»“åº“æ ¹â€æ–‡ä»¶ï¼šä¸¤å±‚é€‰æ‹©ï¼ˆ<name>.<COMPILE_NAME> â†’ <name>ï¼‰ï¼Œå¹¶ chmod
# ç”¨æ³•ï¼šdeploy_root "config" "./.config" "644"
#       deploy_root "feeds.conf.default" "./feeds.conf.default" "644"
#       deploy_root "zzz-default-settings" "./package/lean/default-settings/files/zzz-default-settings" "755"
deploy_root() {
  name="$1"          # ä»“åº“æ ¹æ–‡ä»¶åï¼ˆä¸å¸¦è·¯å¾„ï¼‰
  dst="$2"           # ç›®æ ‡ç»å¯¹è·¯å¾„
  mode="${3:-644}"   # chmod

  site_src="${TMP_DIR}/Lean/${name}.${COMPILE_NAME}"
  def_src="${TMP_DIR}/Lean/${name}"

  if [ -f "${site_src}" ]; then
    echo "[DEPLOY] ${site_src} -> ${dst}"
    safe_cp "${site_src}" "${dst}"
    chmod "${mode}" "${dst}" || true
    __hit "${name} (site=${COMPILE_NAME})"
  elif [ -f "${def_src}" ]; then
    echo "[DEPLOY] ${def_src} -> ${dst}"
    safe_cp "${def_src}" "${dst}"
    chmod "${mode}" "${dst}" || true
    __hit "${name} (default)"
  else
    echo "[SKIP_OK] root ${name} (no site/default needed)"
    __skip "${name}"
  fi
  return 0
}

# 6.3 æ±‡æ€»
deploy_summary() {
  printf '\n[SUMMARY] Profile=%s\n' "${COMPILE_NAME}"

  if [ -n "${__DEPLOY_HITS}" ]; then
    printf '[DEPLOYED]\n%b' "${__DEPLOY_HITS}"
  else
    printf '[DEPLOYED]\n(none)\n'
  fi

  if [ -n "${__DEPLOY_SKIPS}" ]; then
    printf '[SKIPPED OK]\n%b' "${__DEPLOY_SKIPS}"
  else
    printf '[SKIPPED OK]\n(none)\n'
  fi
}

# ==== [7] æ£€æŸ¥ luci feedï¼ˆpo2lmo å·¥å…·æ‰€åœ¨ä½ç½®ï¼‰ ====
if ! grep -qE '^src-git[[:space:]]+luci[[:space:]]+' feeds.conf.default; then
    echo "âš ï¸  feeds.conf.default ç¼ºå°‘ luci æºï¼Œå·²è‡ªåŠ¨è¿½åŠ "
    echo "src-git luci https://github.com/coolsnowwolf/luci" >> feeds.conf.default
fi

# æ›´æ–° luci feed å¹¶å®‰è£… luci-baseï¼ˆåŒ…å« po2lmoï¼‰
./scripts/feeds update luci
./scripts/feeds install luci-base

# ==== [8] å…¨é‡æ›´æ–°å®‰è£… feeds å¹¶æ·»åŠ  luci-theme-neobird ====
echo "ğŸ› ï¸ æ­£åœ¨æ‰§è¡Œ feeds update/install..."
./scripts/feeds clean
./scripts/feeds update -a
./scripts/feeds install -a

#echo "ğŸŒˆ æ·»åŠ  luci-theme-neobird..."
#mkdir -p package/lean
#rm -rf package/lean/luci-theme-neobird
#git clone https://github.com/thinktip/luci-theme-neobird.git package/lean/luci-theme-neobird

# ==== [9] ç¼–è¯‘ po2lmo å·¥å…· ====
echo "ğŸ› ï¸ ç¼–è¯‘ po2lmo å·¥å…·..."
make package/feeds/luci/luci-base/host/compile V=s

# ==== [10.1] é¦–æ¬¡æ„å»ºå¯é€‰ä¸‹è½½æºç åŒ… ====
read -p "ğŸ§ æ˜¯å¦é¦–æ¬¡æ„å»ºï¼Ÿéœ€è¦é¢„ä¸‹è½½æºç åŒ…ï¼Ÿ(y/N): " is_first
if [[ "$is_first" =~ ^[Yy]$ ]]; then
    echo "ğŸ“¥ å¼€å§‹é¢„ä¸‹è½½æºç åŒ…..."
    while true; do
        make download -j8 V=s
        broken=$(find dl -size -1024c)
        if [ -z "$broken" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆä¸”æ ¡éªŒé€šè¿‡"
            break
        else
            echo "âš ï¸ æ£€æµ‹åˆ°ä¸å®Œæ•´æ–‡ä»¶ï¼Œé‡æ–°ä¸‹è½½..."
            find dl -size -1024c -exec rm -f {} \;
        fi
    done
else
    echo "âœ… è·³è¿‡é¢„ä¸‹è½½ï¼Œå¯ç›´æ¥ make -j$(nproc) V=s"
fi

# ==== [10.2] WireGuard ç§é’¥æ³¨å…¥ï¼ˆå¤åˆ¶å‰åœ¨æ¨¡æ¿ä¸­æ›¿æ¢å ä½ç¬¦ï¼‰ ====
# ä½¿ç”¨æ–¹å¼ï¼šåœ¨ä½ çš„æ¨¡æ¿æ–‡ä»¶é‡ŒæŠŠç§é’¥å†™æˆå ä½ç¬¦ï¼š__WG_PRIVKEY__
# ä¾‹ï¼šLean/files/etc/config/network.Riviera é‡Œï¼š
#     option private_key '__WG_PRIVKEY__'

echo
read -p "æ˜¯å¦ä¸º ${COMPILE_NAME} æ³¨å…¥ WireGuard ç§é’¥åˆ°æ¨¡æ¿ï¼Ÿ(y/N): " inject_wgkey
if [[ "$inject_wgkey" =~ ^[Yy]$ ]]; then
  # äº¤äº’å¼è¾“å…¥ï¼ˆéšè—å›æ˜¾ï¼‰+ åŸºæœ¬æ ¼å¼æ ¡éªŒ
  while true; do
    read -p "è¯·è¾“å…¥ ${COMPILE_NAME} çš„ WireGuard ç§é’¥ï¼ˆå…¸å‹44å­—ç¬¦ï¼Œæœ«å°¾=ï¼‰ï¼š " WG_PRIVKEY
    echo
    if [[ "$WG_PRIVKEY" =~ ^[A-Za-z0-9+/]{43}=$ ]]; then
      break
    else
      echo "â— æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ï¼Œè¯·é‡è¯•ã€‚"
    fi
  done

  # ä»…åœ¨ä¸´æ—¶å…‹éš†ç›®å½• $TMP_DIR å†…æ›¿æ¢ï¼Œä¼˜å…ˆç«™ç‚¹åŒ–æ–‡ä»¶ï¼Œå…¶æ¬¡é»˜è®¤æ–‡ä»¶
  echo "ğŸ” æ­£åœ¨æ‰«ææ¨¡æ¿ä¸­çš„å ä½ç¬¦ __WG_PRIVKEY__ ..."
  # ç«™ç‚¹ä¼˜å…ˆï¼š*.${COMPILE_NAME}
  mapfile -t SITE_MATCHES < <(grep -RIl -e '__WG_PRIVKEY__' "${TMP_DIR}/Lean" --include="*.${COMPILE_NAME}" 2>/dev/null || true)
  # é»˜è®¤å…œåº•ï¼šæ— åç¼€
  mapfile -t DEF_MATCHES  < <(grep -RIl -e '__WG_PRIVKEY__' "${TMP_DIR}/Lean" --exclude="*.${COMPILE_NAME}" 2>/dev/null || true)

  REPLACED=0
  if [ ${#SITE_MATCHES[@]} -gt 0 ]; then
    echo "âœï¸  åœ¨ç«™ç‚¹æ¨¡æ¿ä¸­æ›¿æ¢ï¼š"
    for f in "${SITE_MATCHES[@]}"; do
      [ -n "$f" ] || continue
      echo "  - ${f#${TMP_DIR}/}"
      sed -i "s|__WG_PRIVKEY__|${WG_PRIVKEY}|g" "$f"
      REPLACED=$((REPLACED+1))
    done
  fi

  # åªæœ‰å½“ç«™ç‚¹æ¨¡æ¿é‡Œæœªæ‰¾åˆ°å ä½ç¬¦æ—¶ï¼Œæ‰ä¼šå†å°è¯•é»˜è®¤æ–‡ä»¶
  if [ $REPLACED -eq 0 ] && [ ${#DEF_MATCHES[@]} -gt 0 ]; then
    echo "âœï¸  æœªåœ¨ç«™ç‚¹æ¨¡æ¿æ‰¾åˆ°å ä½ç¬¦ï¼Œæ”¹ä¸ºåœ¨é»˜è®¤æ¨¡æ¿ä¸­æ›¿æ¢ï¼š"
    for f in "${DEF_MATCHES[@]}"; do
      [ -n "$f" ] || continue
      echo "  - ${f#${TMP_DIR}/}"
      sed -i "s|__WG_PRIVKEY__|${WG_PRIVKEY}|g" "$f"
      REPLACED=$((REPLACED+1))
    done
  fi

  if [ $REPLACED -gt 0 ]; then
    echo "âœ… å·²åœ¨ ${REPLACED} ä¸ªæ¨¡æ¿æ–‡ä»¶ä¸­å®Œæˆç§é’¥æ›¿æ¢ï¼ˆå¤åˆ¶æ—¶å°†éšä¹‹ç”Ÿæ•ˆï¼‰ã€‚"
  else
    echo "âš ï¸ æœªåœ¨æ¨¡æ¿ä¸­å‘ç°å ä½ç¬¦ã€‚å°†æ”¹ä¸ºç”Ÿæˆ uci-defaults ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚"
    WG_UCI_DEFAULTS_PATH="./files/etc/uci-defaults/99-wg-private-key"
    mkdir -p "$(dirname "$WG_UCI_DEFAULTS_PATH")"
    cat > "$WG_UCI_DEFAULTS_PATH" <<'EOF_UCI'
#!/bin/sh
WG_KEY_PLACEHOLDER="__WG_PRIVKEY__"
if uci -q get network.wg0.proto >/dev/null 2>&1; then
  uci set network.wg0.private_key="$WG_KEY_PLACEHOLDER"
else
  FIRST_WG_IF="$(uci -q show network | awk -F= '/=interface/{print $1}' | while read s; do \
    p="$(uci -q get ${s}.proto 2>/dev/null)"; [ "$p" = "wireguard" ] && echo "$s" && break; done)"
  if [ -n "$FIRST_WG_IF" ]; then
    uci set "$FIRST_WG_IF".private_key="$WG_KEY_PLACEHOLDER"
  else
    uci set network.wg0=interface
    uci set network.wg0.proto='wireguard'
    uci set network.wg0.private_key="$WG_KEY_PLACEHOLDER"
  fi
fi
uci commit network
exit 0
EOF_UCI
    # ç”¨å®é™…å¯†é’¥æ›¿æ¢å ä½ç¬¦ï¼Œè°¨æ…ä¸åœ¨æ§åˆ¶å°å›æ˜¾
    sed -i "s|__WG_PRIVKEY__|${WG_PRIVKEY}|g" "$WG_UCI_DEFAULTS_PATH"
    chmod 600 "$WG_UCI_DEFAULTS_PATH"
    echo "âœ… å·²ç”Ÿæˆå…œåº•è„šæœ¬ï¼š${WG_UCI_DEFAULTS_PATH}ï¼ˆé¦–æ¬¡å¼€æœºè‡ªåŠ¨å†™å…¥ç§é’¥ï¼‰"
  fi
else
  echo "â­ï¸ è·³è¿‡ç§é’¥æ³¨å…¥ã€‚"
fi

# ==== [11] éƒ¨ç½²é…ç½®æ–‡ä»¶ ====
echo "2. éƒ¨ç½² [$COMPILE_NAME] ç¼–è¯‘ç‰ˆæœ¬é…ç½®æ–‡ä»¶..."

# 11.1 ä»“åº“æ ¹ï¼ˆLean/ ä¸‹ï¼‰â€”â€” ç«™ç‚¹ä¼˜å…ˆï¼Œç¼ºå¤±ä¹Ÿè§†ä¸ºæˆåŠŸ
deploy_root "config"                 "./.config"                                                 "644"
deploy_root "feeds.conf.default"     "./feeds.conf.default"                                      "644"
deploy_root "zzz-default-settings"   "./package/lean/default-settings/files/zzz-default-settings" "755"
deploy_root "remove_conflict.sh"     "./remove_conflict.sh"                                      "755"

# 11.2 overlayï¼ˆLean/files/ ä¸‹ï¼‰â€”â€” ä¼ ç›¸å¯¹è·¯å¾„ + æƒé™ï¼›ç«™ç‚¹ä¼˜å…ˆï¼Œç¼ºå¤±ä¹ŸæˆåŠŸ
# å›ç¨‹è·¯ç”±è„šæœ¬
deploy_file "usr/bin/back-route-checkenv.sh"         "755"
deploy_file "usr/bin/back-route-complete.sh"         "755"
deploy_file "usr/bin/back-route-cron.sh"             "755"

# IPSecï¼ˆå¦‚éœ€å¯ç”¨ï¼ŒæŒ‰éœ€å–æ¶ˆæ³¨é‡Šï¼‰
# deploy_file "etc/ipsec.conf"                          "644"
# deploy_file "etc/ipsec.secrets"                       "600"
# deploy_file "etc/config/luci-app-ipsec-server"        "644"

# OpenClash é…ç½®ä¸è„šæœ¬
deploy_file "etc/config/openclash"                   "644"
deploy_file "etc/openclash/custom/openclash_custom_rules.list" "644"
deploy_file "usr/share/openclash/res/rule_providers.list"      "644"
deploy_file "etc/openclash/dns_enable_false.sh"      "755"
deploy_file "usr/share/openclash/yml_proxys_set.sh"  "755"

# WireGuard ç½‘ç»œæ¥å£åˆ·æ–°è„šæœ¬ï¼ˆæŸç«™ç‚¹å¯èƒ½æ²¡æœ‰ï¼Œç¼ºå¤±è§†ä¸ºæˆåŠŸï¼‰
deploy_file "usr/bin/WireGuard_Refresh.sh"           "755"

# å…¶å®ƒç½‘ç»œåŠ é€Ÿã€è®¡åˆ’ä»»åŠ¡ç­‰
deploy_file "etc/config/turboacc"                    "644"
deploy_file "etc/crontabs/root"                      "600"

# ==== [12] åˆ é™¤ä¸´æ—¶ç›®å½• ====
echo "4. åˆ é™¤ä¸´æ—¶ç›®å½• $TMP_DIR"
rm -rf "$TMP_DIR"

./remove_conflict.sh
make defconfig
# ç¬¬äºŒæ¬¡ï¼šåœ¨ defconfig ä¹‹åå…œåº•ä¿®æ­£ .configï¼ˆå†æ¬¡å…³æ‰ ssr-plusï¼‰
./remove_conflict.sh

# å±•ç¤ºéƒ¨ç½²æ‘˜è¦
deploy_summary

# ==== [13] æ˜¾ç¤ºå¤‡ä»½åˆ—è¡¨ ====
if [ ${#BACKUP_LIST[@]} -gt 0 ]; then
    echo "ğŸ—‚ï¸ æœ¬æ¬¡å¤‡ä»½çš„æ–‡ä»¶ï¼š"
    for f in "${BACKUP_LIST[@]}"; do echo "  $f"; done
else
    echo "ğŸ—‚ï¸ æœ¬æ¬¡æ²¡æœ‰æ–‡ä»¶è¢«è¦†ç›–ï¼Œå› æ­¤æ²¡æœ‰å¤‡ä»½"
fi

# ==== [14] æ€»ç»“ ====
echo "ğŸ“‹ æ‰§è¡Œæ­¥éª¤æ€»ç»“ï¼š"
echo "-------------------------------------------------------"
echo "âœ… éƒ¨ç½²å®šåˆ¶æ–‡ä»¶"
echo "âœ… è‡ªåŠ¨å¤‡ä»½å·²æœ‰é…ç½®"
echo "âœ… æ‰§è¡Œ feeds update/install & make defconfig"
echo "âœ… ç¼–è¯‘ po2lmo å·¥å…·"
echo "âœ… ï¼ˆå¯é€‰ï¼‰ä¸‹è½½æºç åŒ…å¹¶æ ¡éªŒ"
echo "âœ… WireGuard ç§é’¥å ä½ç¬¦æ³¨å…¥/å…œåº• uci-defaults"
echo "-------------------------------------------------------"

# ==== [15] å®Œæˆæç¤º ====
echo "ğŸš€ é…ç½®éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ‘‰ å½“å‰æºç ç›®å½•: $(pwd)"
echo "ğŸ’¡ å¯æ‰§è¡Œï¼šmake -j$(nproc) V=s"

#20251204
