#!/bin/bash
# ===========================================================================
# Lean OpenWrt å®šåˆ¶æ–‡ä»¶ä¸€é”®éƒ¨ç½²è„šæœ¬ã€é¡ºåºä¿®æ­£ç‰ˆã€‘
# ===========================================================================
set -e

# --- åŸºç¡€é…ç½®ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰ ---
REPO_URL="https://github.com/your-username/your-repo.git"
TMP_DIR="/tmp/openwrt_custom_files"
COMPILE_NAME="OpenWrt"
BACKUP_LIST=()
declare -A DEPLOY_STATS=( [hit]=0 [skip]=0 )

# --- è¾…åŠ©å‡½æ•° ---
deploy_root() {
    local src_name=$1; local dest_path=$2; local mode=$3
    local src_path="$TMP_DIR/$src_name"
    if [ -f "$src_path" ]; then
        if [ -f "$dest_path" ]; then
            local bak="${dest_path}.bak.$(date +%Y%m%d%H%M%S)"
            cp "$dest_path" "$bak"
            BACKUP_LIST+=("$bak")
        fi
        mkdir -p "$(dirname "$dest_path")"
        cp "$src_path" "$dest_path"
        chmod "$mode" "$dest_path"
        DEPLOY_STATS[hit]=$((DEPLOY_STATS[hit] + 1))
    else
        DEPLOY_STATS[skip]=$((DEPLOY_STATS[skip] + 1))
    fi
}

deploy_file() {
    local sub_path=$1; local mode=$2
    local src_path="$TMP_DIR/files/$sub_path"
    local dest_path="./files/$sub_path"
    if [ -f "$src_path" ]; then
        if [ -f "$dest_path" ]; then
            local bak="${dest_path}.bak.$(date +%Y%m%d%H%M%S)"
            cp "$dest_path" "$bak"
            BACKUP_LIST+=("$bak")
        fi
        mkdir -p "$(dirname "$dest_path")"
        cp "$src_path" "$dest_path"
        chmod "$mode" "$dest_path"
        DEPLOY_STATS[hit]=$((DEPLOY_STATS[hit] + 1))
    else
        DEPLOY_STATS[skip]=$((DEPLOY_STATS[skip] + 1))
    fi
}

deploy_summary() {
    echo -e "\nğŸ“Š éƒ¨ç½²ç»Ÿè®¡ï¼šå‘½ä¸­ ${DEPLOY_STATS[hit]} ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡ ${DEPLOY_STATS[skip]} ä¸ªæ–‡ä»¶ã€‚"
}

# ==== [1-4] åŸºç¡€å‡†å¤‡ ====
if [ ! -f "feeds.conf.default" ]; then
    echo "ğŸ” æœªæ£€æµ‹åˆ° OpenWrt æºç ï¼Œæ­£åœ¨å…‹éš†..."
    git clone https://github.com/coolsnowwolf/lede .
fi

echo "ğŸ“‚ å…‹éš†å®šåˆ¶é…ç½®ä»“åº“..."
rm -rf "$TMP_DIR"
git clone "$REPO_URL" "$TMP_DIR"

# ==== [10.2] WireGuard ç§é’¥æ³¨å…¥ (åŸä½ç½®è°ƒæ•´ï¼šå¿…é¡»åœ¨å¤åˆ¶æ–‡ä»¶å‰ä¿®æ”¹ä¸´æ—¶æ–‡ä»¶) ====
read -p "ğŸ” æ˜¯å¦æ³¨å…¥ WireGuard ç§é’¥ï¼Ÿ(y/N): " do_wg
if [[ "$do_wg" =~ ^[Yy]$ ]]; then
  read -p "è¯·è¾“å…¥ç§é’¥ (Private Key): " WG_PRIVKEY
  if [ -n "$WG_PRIVKEY" ]; then
    echo "æ­£åœ¨æ³¨å…¥ç§é’¥åˆ°ä¸´æ—¶ç›®å½•ä¸­çš„æ¨¡æ¿..."
    grep -rl "__WG_PRIVKEY__" "$TMP_DIR" | xargs -r sed -i "s|__WG_PRIVKEY__|${WG_PRIVKEY}|g"
    
    WG_UCI_DEFAULTS_PATH="$TMP_DIR/files/etc/uci-defaults/99-wg-privkey"
    if ! grep -rl "$WG_PRIVKEY" "$TMP_DIR" > /dev/null; then
      echo "âš ï¸ æœªåœ¨æ¨¡æ¿ä¸­å‘ç°å ä½ç¬¦ï¼Œç”Ÿæˆ uci-defaults è„šæœ¬..."
      mkdir -p "$(dirname "$WG_UCI_DEFAULTS_PATH")"
      cat <<EOF_UCI > "$WG_UCI_DEFAULTS_PATH"
#!/bin/sh
uci set network.wg0.private_key='${WG_PRIVKEY}'
uci commit network
exit 0
EOF_UCI
      chmod 755 "$WG_UCI_DEFAULTS_PATH"
    fi
  fi
fi

# ==== [11.1] éƒ¨ç½² feeds.conf.default ====
echo "ğŸš€ éƒ¨ç½² feeds æºé…ç½®..."
deploy_root "feeds.conf.default" "./feeds.conf.default" "644"

# ==== [8] & [9] å…¨é‡æ›´æ–°å®‰è£… feeds (åŸä½ç½®è°ƒæ•´ï¼šå¿…é¡»åœ¨éƒ¨ç½² .config å‰) ====
echo "ğŸ› ï¸ æ­£åœ¨æ‰§è¡Œ feeds update/install..."
if ! grep -qE '^src-git[[:space:]]+luci[[:space:]]+' feeds.conf.default; then
    echo "src-git luci https://github.com/coolsnowwolf/luci" >> feeds.conf.default
fi
./scripts/feeds clean
./scripts/feeds update -a
./scripts/feeds install -a

echo "ğŸ› ï¸ ç¼–è¯‘ po2lmo å·¥å…·..."
make package/feeds/luci/luci-base/host/compile V=s || true

echo "ğŸŒˆ æ·»åŠ  luci-theme-neobird..."
mkdir -p package/lean
rm -rf package/lean/luci-theme-neobird
git clone https://github.com/thinktip/luci-theme-neobird.git package/lean/luci-theme-neobird

# ==== [11.2] éƒ¨ç½² .config ä¸ä½ çš„æ‰€æœ‰ files (ä¿ç•™ä½ åŸæœ‰çš„å…¨éƒ¨æ–‡ä»¶åˆ—è¡¨) ====
echo "ğŸ“‚ éƒ¨ç½²å®šåˆ¶é…ç½®æ–‡ä»¶åŠ Overlay..."
deploy_root "config" "./.config" "644"
deploy_root "zzz-default-settings" "./package/lean/default-settings/files/zzz-default-settings" "755"
deploy_root "remove_conflict.sh" "./remove_conflict.sh" "755"

# --- æ­¤å¤„ä¿ç•™ä½ åŸæœ‰çš„æ‰€æœ‰æ–‡ä»¶æ¸…å• ---
deploy_file "usr/bin/back-route-checkenv.sh" "755"
deploy_file "usr/bin/back-route-complete.sh" "755"
deploy_file "usr/bin/back-route-cron.sh" "755"
deploy_file "etc/config/network" "644"
deploy_file "etc/config/wireless" "644"
deploy_file "etc/config/dhcp" "644"
deploy_file "etc/config/firewall" "644"
deploy_file "etc/config/passwall" "644"
deploy_file "etc/config/smartdns" "644"
deploy_file "etc/config/aria2" "644"
deploy_file "etc/config/mwan3" "644"
deploy_file "etc/config/upnpd" "644"
deploy_file "etc/config/samba4" "644"
deploy_file "etc/config/ttyd" "644"
deploy_file "etc/config/fstab" "644"
deploy_file "etc/config/aliddns" "644"
deploy_file "etc/config/ddns" "644"
deploy_file "etc/config/wol" "644"
deploy_file "etc/config/cpufreq" "644"
deploy_file "etc/config/turboacc" "644"
deploy_file "etc/crontabs/root" "600"

# ==== [13] é…ç½®å›ºåŒ– (make defconfig) ====
echo "âš™ï¸ æ­£åœ¨æ‰§è¡Œé…ç½®å›ºåŒ–..."
if [ -f "./remove_conflict.sh" ]; then
    ./remove_conflict.sh
fi
make defconfig
if [ -f "./remove_conflict.sh" ]; then
    ./remove_conflict.sh
fi

# ==== [10.1] æºç é¢„ä¸‹è½½ (åŸä½ç½®è°ƒæ•´ï¼šå¿…é¡»åœ¨é…ç½®å›ºåŒ–å) ====
read -p "ğŸ§ æ˜¯å¦æ‰§è¡Œæºç é¢„ä¸‹è½½ï¼Ÿ(y/N): " is_first
if [[ "$is_first" =~ ^[Yy]$ ]]; then
    echo "ğŸ“¥ å¼€å§‹é¢„ä¸‹è½½æºç åŒ…..."
    while true; do
        make download -j8 V=s
        broken=$(find dl -size -1024c)
        if [ -z "$broken" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            break
        else
            echo "âš ï¸ æ¸…ç†æŸåæ–‡ä»¶å¹¶é‡è¯•..."
            find dl -size -1024c -exec rm -f {} \;
        fi
    done
fi

# ==== [12] åˆ é™¤ä¸´æ—¶ç›®å½• ====
echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶ç›®å½•..."
rm -rf "$TMP_DIR"

# ==== [14] æ€»ç»“ä¸æ˜¾ç¤º ====
deploy_summary

if [ ${#BACKUP_LIST[@]} -gt 0 ]; then
    echo "ğŸ—‚ï¸ å¤‡ä»½æ–‡ä»¶æ¸…å•ï¼š"
    for f in "${BACKUP_LIST[@]}"; do echo "  $f"; done
fi

echo "âœ¨ éƒ¨ç½²æˆåŠŸï¼"
