#!/bin/bash
# ===========================================================================
# Lean OpenWrt å®šåˆ¶æ–‡ä»¶ä¸€é”®éƒ¨ç½²è„šæœ¬ã€é€»è¾‘ä¿®æ­£ç‰ˆã€‘
# ===========================================================================
set -e

# --- åŸºç¡€é…ç½® ---
REPO_URL="https://github.com/your-username/your-repo.git" # ä½ çš„å®šåˆ¶ä»“åº“åœ°å€
TMP_DIR="/tmp/openwrt_custom_files"
BACKUP_LIST=()
declare -A DEPLOY_STATS=( [hit]=0 [skip]=0 )

# --- è¾…åŠ©å‡½æ•° ---
# å¤‡ä»½å¹¶éƒ¨ç½²æ–‡ä»¶åˆ°æ ¹ç›®å½•
deploy_root() {
    local src_name=$1; local dest_path=$2; local mode=$3
    local src_path="$TMP_DIR/$src_name"
    if [ -f "$src_path" ]; then
        if [ -f "$dest_path" ]; then
            local bak="${dest_path}.bak.$(date +%Y%m%d%H%M%S)"
            cp "$dest_path" "$bak"
            BACKUP_LIST+=("$bak")
        fi
        mkdir -p "$(dirname "$dest_path")"
        cp "$src_path" "$dest_path"
        chmod "$mode" "$dest_path"
        DEPLOY_STATS[hit]=$((DEPLOY_STATS[hit] + 1))
    else
        DEPLOY_STATS[skip]=$((DEPLOY_STATS[skip] + 1))
    fi
}

# éƒ¨ç½² files/ ç›®å½•ä¸‹çš„æ–‡ä»¶
deploy_file() {
    local sub_path=$1; local mode=$2
    local src_path="$TMP_DIR/files/$sub_path"
    local dest_path="./files/$sub_path"
    if [ -f "$src_path" ]; then
        if [ -f "$dest_path" ]; then
            local bak="${dest_path}.bak.$(date +%Y%m%d%H%M%S)"
            cp "$dest_path" "$bak"
            BACKUP_LIST+=("$bak")
        fi
        mkdir -p "$(dirname "$dest_path")"
        cp "$src_path" "$dest_path"
        chmod "$mode" "$dest_path"
        DEPLOY_STATS[hit]=$((DEPLOY_STATS[hit] + 1))
    else
        DEPLOY_STATS[skip]=$((DEPLOY_STATS[skip] + 1))
    fi
}

deploy_summary() {
    echo -e "\nğŸ“Š éƒ¨ç½²ç»Ÿè®¡ï¼šå‘½ä¸­ ${DEPLOY_STATS[hit]} ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡ ${DEPLOY_STATS[skip]} ä¸ªæ–‡ä»¶ã€‚"
}

# ==== [1-4] ç¯å¢ƒå‡†å¤‡ ====
if [ ! -f "feeds.conf.default" ]; then
    echo "ğŸ” æœªæ£€æµ‹åˆ° OpenWrt æºç ï¼Œæ­£åœ¨å…‹éš† Lean ä»“åº“..."
    git clone https://github.com/coolsnowwolf/lede .
fi

echo "ğŸ“‚ å…‹éš†å®šåˆ¶é…ç½®ä»“åº“..."
rm -rf "$TMP_DIR"
git clone "$REPO_URL" "$TMP_DIR"

# ==== [10.2] WireGuard ç§é’¥æ³¨å…¥ (å¿…é¡»åœ¨å¤åˆ¶æ–‡ä»¶å‰æ‰§è¡Œ) ====
# åœ¨ä¸´æ—¶ç›®å½•ä¸­å…ˆè¡Œæ›¿æ¢å ä½ç¬¦ï¼Œè¿™æ ·éšåéƒ¨ç½²çš„å°±æ˜¯å«çœŸå®å¯†é’¥çš„æ–‡ä»¶
read -p "ğŸ” æ˜¯å¦æ³¨å…¥ WireGuard ç§é’¥ï¼Ÿ(y/N): " do_wg
if [[ "$do_wg" =~ ^[Yy]$ ]]; then
    read -p "è¯·è¾“å…¥ç§é’¥ (Private Key): " WG_PRIVKEY
    if [ -n "$WG_PRIVKEY" ]; then
        echo "æ³¨å…¥ç§é’¥åˆ°ä¸´æ—¶ç›®å½•..."
        # æ‰«æä¸´æ—¶ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶è¿›è¡Œæ›¿æ¢
        grep -rl "__WG_PRIVKEY__" "$TMP_DIR" | xargs -r sed -i "s|__WG_PRIVKEY__|${WG_PRIVKEY}|g"
        
        # å…œåº•é€»è¾‘ï¼šå¦‚æœ files/etc/config/network æ²¡è¢«æ›¿æ¢ï¼Œç”Ÿæˆ uci-defaults
        WG_UCI_DEFAULTS_PATH="$TMP_DIR/files/etc/uci-defaults/99-wg-privkey"
        if ! grep -rl "$WG_PRIVKEY" "$TMP_DIR" > /dev/null; then
            echo "âš ï¸ æœªåœ¨æ¨¡æ¿ä¸­å‘ç°å ä½ç¬¦ï¼Œç”Ÿæˆ uci-defaults è„šæœ¬..."
            mkdir -p "$(dirname "$WG_UCI_DEFAULTS_PATH")"
            cat <<EOF > "$WG_UCI_DEFAULTS_PATH"
#!/bin/sh
uci set network.wg0.private_key='${WG_PRIVKEY}'
uci commit network
exit 0
EOF
            chmod 755 "$WG_UCI_DEFAULTS_PATH"
        fi
    fi
fi

# ==== [11.1] ä¼˜å…ˆéƒ¨ç½² feeds.conf.default ====
echo "ğŸš€ éƒ¨ç½² feeds æºé…ç½®..."
deploy_root "feeds.conf.default" "./feeds.conf.default" "644"

# ==== [8] & [9] æ›´æ–° Feeds å¹¶å®‰è£…åŒ…å®šä¹‰ ====
# å¿…é¡»å…ˆå®‰è£… feedsï¼Œåç»­çš„ .config æ‰èƒ½è¢«è¯†åˆ«ï¼Œä¸ä¼šè¢« make defconfig åˆ æ‰
echo "ğŸ› ï¸ æ­£åœ¨æ‰§è¡Œ feeds update/install..."
./scripts/feeds clean
./scripts/feeds update -a
./scripts/feeds install -a

# ç¼–è¯‘ po2lmo å·¥å…·ï¼ˆé€šå¸¸åç»­ç¼–è¯‘éœ€è¦ï¼‰
echo "ğŸ› ï¸ ç¼–è¯‘ po2lmo å·¥å…·..."
make package/feeds/luci/luci-base/host/compile V=s || echo "âš ï¸ po2lmo ç¼–è¯‘è·³è¿‡æˆ–å¤±è´¥"

# æ·»åŠ ä¸»é¢˜
echo "ğŸŒˆ æ·»åŠ  luci-theme-neobird..."
mkdir -p package/lean
rm -rf package/lean/luci-theme-neobird
git clone https://github.com/thinktip/luci-theme-neobird.git package/lean/luci-theme-neobird

# ==== [11.2] éƒ¨ç½² .config ä¸ Overlay æ–‡ä»¶ ====
echo "ğŸ“‚ éƒ¨ç½²å®šåˆ¶é…ç½®æ–‡ä»¶..."
deploy_root "config" "./.config" "644"
deploy_root "zzz-default-settings" "./package/lean/default-settings/files/zzz-default-settings" "755"
deploy_root "remove_conflict.sh" "./remove_conflict.sh" "755"

# éƒ¨ç½² overlay æ–‡ä»¶ (files/)
# æ³¨æ„ï¼šæ­¤å¤„çš„åˆ—è¡¨åº”æ ¹æ®ä½ ä»“åº“å®é™…æœ‰çš„æ–‡ä»¶è°ƒæ•´ï¼Œæˆ–å†™ä¸€ä¸ª loop è‡ªåŠ¨éå†
if [ -d "$TMP_DIR/files" ]; then
    cp -r "$TMP_DIR/files/." "./files/"
    echo "âœ… å·²åŒæ­¥ files/ ç›®å½•æ‰€æœ‰å†…å®¹"
fi

# ==== [13] é…ç½®å›ºåŒ– (Defconfig) ====
echo "âš™ï¸ æ­£åœ¨æ‰§è¡Œé…ç½®å›ºåŒ– (make defconfig)..."
if [ -f "./remove_conflict.sh" ]; then
    ./remove_conflict.sh
fi
make defconfig
if [ -f "./remove_conflict.sh" ]; then
    ./remove_conflict.sh
fi

# ==== [10.1] æºç é¢„ä¸‹è½½ (å¿…é¡»åœ¨ defconfig ä¹‹å) ====
read -p "ğŸ§ æ˜¯å¦æ‰§è¡Œæºç é¢„ä¸‹è½½ï¼Ÿ(y/N): " is_first
if [[ "$is_first" =~ ^[Yy]$ ]]; then
    echo "ğŸ“¥ å¼€å§‹ä¸‹è½½æºç åŒ…..."
    while true; do
        make download -j8 V=s
        # æ ¡éªŒä¸‹è½½æ˜¯å¦å®Œæ•´ï¼ˆåˆ é™¤å°äº1KBçš„æ–‡ä»¶ï¼‰
        broken=$(find dl -size -1024c)
        if [ -z "$broken" ]; then
            echo "âœ… æ‰€æœ‰æºç ä¸‹è½½å®Œæˆ"
            break
        else
            echo "âš ï¸ å‘ç°æŸåæ–‡ä»¶ï¼Œæ¸…ç†å¹¶é‡è¯•..."
            find dl -size -1024c -exec rm -f {} \;
        fi
    done
fi

# ==== [12] æ¸…ç†ä¸´æ—¶ç›®å½• ====
echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -rf "$TMP_DIR"

# ==== [14] æ€»ç»“ä¸å±•ç¤º ====
deploy_summary

if [ ${#BACKUP_LIST[@]} -gt 0 ]; then
    echo "ğŸ—‚ï¸ æœ¬æ¬¡å¤‡ä»½çš„æ—§æ–‡ä»¶æ¸…å•ï¼š"
    for f in "${BACKUP_LIST[@]}"; do echo "  $f"; done
fi

echo -e "\nâœ¨ éƒ¨ç½²å®Œæˆï¼ç°åœ¨å¯ä»¥è¿è¡Œ 'make -j\$(nproc) V=s' å¼€å§‹ç¼–è¯‘äº†ã€‚"
