#!/bin/sh
# ============================================================================
# è„šæœ¬åç§°ï¼šdocker_alpine.sh
# åŠŸèƒ½ï¼šåœ¨ Alpine Linux ä¸Šä¸€é”®éƒ¨ç½² Dockerã€Docker Composeã€å¸¸ç”¨å·¥å…·
# ç‰¹ç‚¹ï¼šå¹‚ç­‰æ€§ã€å®‰å…¨æ€§ã€å¯é‡å¤æ‰§è¡Œï¼Œè‡ªåŠ¨æ£€æµ‹æ˜¯å¦å·²å®‰è£…ã€é…ç½®é¡¹æ˜¯å¦å­˜åœ¨
# ä½œè€…ï¼šhttps://github.com/dayunliang
# æ—¥æœŸï¼š2025-06-29
# ============================================================================

# é‡åˆ°ä»»ä½•å‘½ä»¤å‡ºé”™ç«‹å³ç»ˆæ­¢è„šæœ¬ï¼Œé¿å…å‡ºç°æœªå®Œæˆæˆ–é”™è¯¯çš„å®‰è£…çŠ¶æ€
set -e

# ----------------------------------------------------------------------------
# 0. æ£€æŸ¥å½“å‰æ˜¯å¦ä¸º root ç”¨æˆ·ï¼Œå› ä¸ºå®‰è£…ç³»ç»Ÿç»„ä»¶éœ€è¦ root æƒé™
# ----------------------------------------------------------------------------
echo "ğŸ”§ æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·..."
if [ "$(id -u)" != "0" ]; then
  echo "âŒ è¯·ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œæœ¬è„šæœ¬ã€‚"
  exit 1
fi

# ----------------------------------------------------------------------------
# 1. æ›´æ¢ Alpine Linux çš„ apk åŒ…ç®¡ç†é•œåƒæºä¸º USTCï¼ˆä¸­å›½ç§‘æŠ€å¤§å­¦ï¼‰ï¼ŒåŠ é€Ÿä¸‹è½½
# ----------------------------------------------------------------------------
echo "ğŸ”§ 1. è®¾ç½® APK é•œåƒæºä¸º USTC..."
tee /etc/apk/repositories <<-'EOF'
https://mirrors.ustc.edu.cn/alpine/latest-stable/main
https://mirrors.ustc.edu.cn/alpine/latest-stable/community
EOF
# ä½¿ç”¨ tee + EOF é‡å®šå‘è¦†ç›–åŸå§‹æºåˆ—è¡¨å†…å®¹

# ----------------------------------------------------------------------------
# 2. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•ï¼Œè·å–æœ€æ–°çš„å¯ç”¨åŒ…åˆ—è¡¨
# ----------------------------------------------------------------------------
echo "ğŸ“¦ 2. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•..."
apk update

# ----------------------------------------------------------------------------
# 3. å®‰è£… dockerã€openrcï¼ˆç³»ç»ŸæœåŠ¡ç®¡ç†å™¨ï¼‰å’Œ curl å·¥å…·
# æ£€æŸ¥ docker æ˜¯å¦å·²å®‰è£…ï¼Œè‹¥æœªå®‰è£…åˆ™æ‰§è¡Œå®‰è£…
# ----------------------------------------------------------------------------
echo "ğŸ“¥ 3. å®‰è£… Docker ä¸ OpenRC..."
if apk info -e docker > /dev/null 2>&1; then
  echo "âœ… docker å·²å®‰è£…ï¼Œè·³è¿‡å®‰è£…ã€‚"
else
  apk add --no-cache docker openrc curl
  # --no-cache å¯é¿å…ä¸‹è½½ç¼“å­˜æ®‹ç•™ï¼ŒåŠ å¿«è„šæœ¬è¿è¡Œé€Ÿåº¦
fi

# ----------------------------------------------------------------------------
# 4. æ·»åŠ  Docker åˆ°å¼€æœºå¯åŠ¨åˆ—è¡¨ï¼ˆrc-update æ˜¯ Alpine ä½¿ç”¨çš„ init ç³»ç»Ÿï¼‰
# ----------------------------------------------------------------------------
echo "ğŸš€ 4. è®¾ç½® Docker ä¸ºå¼€æœºå¯åŠ¨æœåŠ¡..."
if ! rc-update show | grep -q docker; then
  rc-update add docker boot
  echo "âœ… å·²æ·»åŠ  docker åˆ°å¯åŠ¨é¡¹ã€‚"
else
  echo "ğŸ” docker å·²åœ¨å¯åŠ¨é¡¹ä¸­ï¼Œè·³è¿‡ã€‚"
fi

# ----------------------------------------------------------------------------
# 5. é…ç½® Docker é•œåƒåŠ é€Ÿå™¨ï¼Œæå‡ pull é•œåƒé€Ÿåº¦
# è‹¥å·²æœ‰é…ç½®æ–‡ä»¶ /etc/docker/daemon.json åˆ™å¤‡ä»½åå†å†™å…¥æ–°å†…å®¹
# ----------------------------------------------------------------------------
echo "ğŸ”§ 5. é…ç½® Docker é•œåƒåŠ é€Ÿå™¨..."
mkdir -p /etc/docker
# ç¡®ä¿ /etc/docker ç›®å½•å­˜åœ¨ï¼ˆidempotentï¼‰

if [ -f /etc/docker/daemon.json ]; then
  echo "ğŸ“ å·²å­˜åœ¨ daemon.jsonï¼Œå¤‡ä»½ä¸º daemon.json.bak"
  cp /etc/docker/daemon.json /etc/docker/daemon.json.bak
fi

# å†™å…¥å›½å†…å¸¸ç”¨ Docker é•œåƒåŠ é€Ÿå™¨åˆ—è¡¨
tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.nju.edu.cn",
    "https://docker.mirrors.sjtug.sjtu.edu.cn",
    "https://mirror.iscas.ac.cn"
  ]
}
EOF

# ----------------------------------------------------------------------------
# 6. å¯åŠ¨ docker æœåŠ¡ï¼Œå¹¶é‡æ–°åŠ è½½é…ç½®ï¼ˆrestart æˆ–é¦–æ¬¡å¯åŠ¨ï¼‰
# ----------------------------------------------------------------------------
echo "ğŸ“¡ 6. å¯åŠ¨å¹¶é‡å¯ Docker æœåŠ¡..."
service docker restart || service docker start
# è‹¥ restart å¤±è´¥ï¼ˆæœåŠ¡æœªå¯åŠ¨ï¼‰åˆ™æ”¹ä¸ºå¯åŠ¨æœåŠ¡

# ----------------------------------------------------------------------------
# 7. å®‰è£… docker-composeï¼ˆäºŒè¿›åˆ¶æ–¹å¼ï¼‰ï¼Œè‹¥æœªå®‰è£…åˆ™ä» GitHub ä¸‹è½½æœ€æ–°ç‰ˆ
# ----------------------------------------------------------------------------
echo "ğŸ”§ 7. å®‰è£… Docker Compose..."
if [ -f /usr/local/bin/docker-compose ]; then
  echo "âœ… docker-compose å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…ã€‚"
else
  # è·å– docker/compose çš„ GitHub æœ€æ–°ç‰ˆæœ¬å·
  DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep tag_name | cut -d '"' -f4)

  # ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶
  curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/bin/docker-compose

  # èµ‹äºˆæ‰§è¡Œæƒé™
  chmod +x /usr/local/bin/docker-compose
  echo "âœ… å®‰è£…å®Œæˆï¼šdocker-compose ${DOCKER_COMPOSE_VERSION}"
fi

# ----------------------------------------------------------------------------
# 8. å®‰è£…å¸¸ç”¨ç³»ç»Ÿå·¥å…·ï¼ˆbashã€curlã€vimã€htopã€ca-certificatesï¼‰
# ä½¿ç”¨ apk info -e åˆ¤æ–­æ˜¯å¦å·²å®‰è£…
# ----------------------------------------------------------------------------
echo "ğŸ§° 8. å®‰è£…å¸¸ç”¨å·¥å…·ï¼ˆbash, curl, vim, htop, ca-certificatesï¼‰..."

# å®šä¹‰å¸¸ç”¨å·¥å…·åˆ—è¡¨
TOOLS="bash curl vim htop ca-certificates"

# éå†å¹¶å®‰è£…æ¯ä¸ªå·¥å…·ï¼ˆè‹¥æœªå®‰è£…ï¼‰
for pkg in $TOOLS; do
  if apk info -e "$pkg" > /dev/null 2>&1; then
    echo "âœ… å·²å®‰è£…ï¼š$pkg"
  else
    echo "ğŸ“¦ æ­£åœ¨å®‰è£…ï¼š$pkg ..."
    apk add --no-cache "$pkg"
    echo "ğŸ“¥ å®‰è£…å®Œæˆï¼š$pkg"
  fi
done

# ----------------------------------------------------------------------------
# 9. éªŒè¯å®‰è£…ç»“æœï¼Œå¹¶å±•ç¤ºé•œåƒåŠ é€Ÿå™¨è®¾ç½®æƒ…å†µ
# ----------------------------------------------------------------------------
echo "ğŸ” 9. éªŒè¯ Docker å’Œ Compose å®‰è£…ç»“æœ..."
docker version
docker-compose version

echo "------ å½“å‰å¯ç”¨çš„é•œåƒåŠ é€Ÿå™¨åˆ—è¡¨ ------"
docker info | grep -A20 "Registry Mirrors"

# ----------------------------------------------------------------------------
# æœ€åæç¤ºç”¨æˆ·å¯ä»¥æ‰§è¡Œ docker æµ‹è¯•å‘½ä»¤
# ----------------------------------------------------------------------------
echo "ğŸ‰ Docker + Compose + å¸¸ç”¨å·¥å…·ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“ å»ºè®®è¿è¡Œï¼šdocker run hello-world è¿›è¡Œæµ‹è¯•ã€‚"
